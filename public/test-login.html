<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录测试页面</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; }
        input, button { padding: 10px; margin: 5px 0; }
        .captcha { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        .result { margin: 20px 0; padding: 10px; background: #f0f0f0; }
    </style>
</head>
<body>
    <h1>登录测试页面</h1>
    
    <div class="form-group">
        <button onclick="loadCaptcha()">1. 获取验证码</button>
        <div id="captchaContainer" class="captcha">验证码将显示在这里</div>
        <input type="hidden" id="captchaId">
    </div>
    
    <div class="form-group">
        <label>2. 填写登录信息</label>
        <input type="text" id="username" placeholder="用户名" value="admin">
        <input type="password" id="password" placeholder="密码" value="admin123">
        <input type="text" id="captchaText" placeholder="验证码">
    </div>
    
    <div class="form-group">
        <button onclick="testLogin()">3. 测试登录</button>
    </div>
    
    <div id="result" class="result">结果将显示在这里</div>
    
    <script>
        async function loadCaptcha() {
            try {
                console.log('Loading captcha...');
                const response = await fetch('/auth/captcha');
                const data = await response.json();
                
                console.log('Captcha response:', data);
                
                document.getElementById('captchaId').value = data.id;
                document.getElementById('captchaContainer').innerHTML = data.svg;
                document.getElementById('result').innerHTML = `✅ 验证码加载成功！ID: ${data.id}`;
            } catch (error) {
                console.error('Captcha error:', error);
                document.getElementById('result').innerHTML = `❌ 验证码加载失败: ${error.message}`;
            }
        }
        
        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const captchaId = document.getElementById('captchaId').value;
            const captchaText = document.getElementById('captchaText').value;
            
            console.log('Form data:', { username, password: '***', captchaId, captchaText });
            
            if (!username || !password || !captchaId || !captchaText) {
                document.getElementById('result').innerHTML = '❌ 请填写所有字段！';
                return;
            }
            
            try {
                // 方法1: FormData
                console.log('Trying FormData method...');
                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);
                formData.append('captchaId', captchaId);
                formData.append('captchaText', captchaText);
                
                const response1 = await fetch('/auth/login', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                console.log('FormData response status:', response1.status);
                const data1 = await response1.json();
                console.log('FormData response:', data1);
                
                if (response1.ok) {
                    document.getElementById('result').innerHTML = `✅ FormData 登录成功！${JSON.stringify(data1)}`;
                    return;
                }
                
                // 方法2: URL-encoded
                console.log('Trying URL-encoded method...');
                const urlData = new URLSearchParams();
                urlData.append('username', username);
                urlData.append('password', password);
                urlData.append('captchaId', captchaId);
                urlData.append('captchaText', captchaText);
                
                const response2 = await fetch('/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: urlData,
                    credentials: 'include'
                });
                
                console.log('URLencoded response status:', response2.status);
                const data2 = await response2.json();
                console.log('URLencoded response:', data2);
                
                if (response2.ok) {
                    document.getElementById('result').innerHTML = `✅ URLencoded 登录成功！${JSON.stringify(data2)}`;
                } else {
                    document.getElementById('result').innerHTML = `
                        ❌ 两种方法都失败了<br>
                        FormData: ${response1.status} - ${JSON.stringify(data1)}<br>
                        URLencoded: ${response2.status} - ${JSON.stringify(data2)}
                    `;
                }
                
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('result').innerHTML = `❌ 网络错误: ${error.message}`;
            }
        }
        
        // 页面加载时自动获取验证码
        window.onload = loadCaptcha;
    </script>
</body>
</html>