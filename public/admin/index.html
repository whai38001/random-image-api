<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšæœºå›¾ç‰‡API - åå°ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .image-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .image-card:hover {
            transform: translateY(-5px);
        }
        
        .image-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .image-card-content {
            padding: 15px;
        }
        
        .image-card-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .image-card-meta {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .image-card-actions {
            display: flex;
            gap: 10px;
        }
        
        .thumbnail-container {
            position: relative;
            width: 100%;
            height: 200px;
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .thumbnail:hover {
            transform: scale(1.05);
        }
        
        .thumbnail.placeholder-image {
            opacity: 0.7;
            filter: blur(1px);
        }
        
        .thumbnail.loading {
            opacity: 0.5;
            animation: pulse 1.5s ease-in-out infinite alternate;
        }
        
        .thumbnail.loaded {
            opacity: 1;
            filter: none;
            transition: opacity 0.3s ease, filter 0.3s ease;
        }
        
        @keyframes pulse {
            from { opacity: 0.5; }
            to { opacity: 0.8; }
        }
        
        .thumbnail-overlay {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .image-id {
            font-weight: bold;
        }
        
        .batch-toolbar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        
        .batch-actions {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .selected-count {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .image-checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 20px;
            height: 20px;
            z-index: 10;
        }
        
        .image-card.selected {
            border: 3px solid #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .thumbnail-container {
            position: relative;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        
        .close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        
        .close:hover {
            color: #000;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            display: none;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #666;
        }
        
        .api-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .api-info h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .api-endpoint {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin-bottom: 10px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            gap: 10px;
        }
        
        .page-numbers {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .page-number {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .page-number:hover {
            background: #f8f9fa;
        }
        
        .page-number.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .page-number.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .pagination-info {
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .images-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .pagination {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .page-numbers {
                flex-wrap: wrap;
                gap: 3px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>éšæœºå›¾ç‰‡APIç®¡ç†ç³»ç»Ÿ</h1>
                    <p>ç®¡ç†ä½ çš„å›¾ç‰‡åº“ï¼Œæ”¯æŒé£æ™¯ã€åŠ¨æ¼«ã€ç¾å¥³ç­‰åˆ†ç±»ï¼ŒPCå’Œç§»åŠ¨ç«¯é€‚é…</p>
                </div>
                <div style="text-align: right; color: rgba(255,255,255,0.9);">
                    <div id="userInfo" style="margin-bottom: 10px; font-size: 14px;"></div>
                    <button onclick="logout()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: all 0.3s;">
                        ç™»å‡º
                    </button>
                </div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalImages">0</div>
                <div>æ€»å›¾ç‰‡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="landscapeImages">0</div>
                <div>æ¨ªå±å›¾ç‰‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="portraitImages">0</div>
                <div>ç«–å±å›¾ç‰‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="categories">0</div>
                <div>åˆ†ç±»æ•°é‡</div>
            </div>
            <div class="stat-card" style="background: #f8f9fa; cursor: pointer;" onclick="forceUpdateStats()" title="ç‚¹å‡»åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯">
                <div class="stat-number" style="font-size: 24px;">ğŸ”„</div>
                <div>åˆ·æ–°ç»Ÿè®¡</div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('upload')">ä¸Šä¼ å›¾ç‰‡</button>
            <button class="tab" onclick="showTab('search')">æœç´¢å›¾ç‰‡</button>
            <button class="tab" onclick="showTab('manage')">ç®¡ç†å›¾ç‰‡</button>
            <button class="tab" onclick="showTab('users')">è´¦å·ç®¡ç†</button>
            <button class="tab" onclick="showTab('security')">å®‰å…¨è®¾ç½®</button>
            <button class="tab" onclick="showTab('system')">ç³»ç»Ÿè®¾ç½®</button>
        </div>
        
        <div id="uploadTab" class="tab-content active">
            <div class="alert alert-success" id="successAlert"></div>
            <div class="alert alert-error" id="errorAlert"></div>
            
            <h2>æ·»åŠ æ–°å›¾ç‰‡</h2>
            <form id="uploadForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="category">åˆ†ç±»</label>
                        <select id="category" name="category" required>
                            <option value="">é€‰æ‹©åˆ†ç±»</option>
                            <option value="landscape">é£æ™¯</option>
                            <option value="anime">åŠ¨æ¼«</option>
                            <option value="beauty">ç¾å¥³</option>
                            <option value="nature">è‡ªç„¶</option>
                            <option value="city">åŸå¸‚</option>
                            <option value="art">è‰ºæœ¯</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="orientation">æ–¹å‘</label>
                        <select id="orientation" name="orientation" required>
                            <option value="">é€‰æ‹©æ–¹å‘</option>
                            <option value="landscape">æ¨ªå± (PC)</option>
                            <option value="portrait">ç«–å± (Mobile)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="imageFile">æœ¬åœ°å›¾ç‰‡ä¸Šä¼ </label>
                    <input type="file" id="imageFile" name="image" accept="image/*">
                    <div id="uploadProgress" style="display: none; margin-top: 10px;">
                        <div style="background: #e1e5e9; border-radius: 4px; overflow: hidden;">
                            <div id="progressBar" style="height: 4px; background: #667eea; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                        <div id="progressText" style="font-size: 12px; color: #666; margin-top: 5px;">ä¸Šä¼ ä¸­...</div>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 20px 0; color: #666;">æˆ–</div>
                
                <div class="form-group">
                    <label for="imageUrl">å›¾ç‰‡URL</label>
                    <input type="url" id="imageUrl" name="url" placeholder="https://example.com/image.jpg">
                </div>
                
                <button type="submit" class="btn">æ·»åŠ å›¾ç‰‡</button>
            </form>
        </div>
        
        <!-- ğŸ” æœç´¢å›¾ç‰‡æ ‡ç­¾é¡µ -->
        <div id="searchTab" class="tab-content">
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-group" style="flex: 2;">
                    <label for="searchQuery">ğŸ” æœç´¢å…³é”®è¯</label>
                    <div style="position: relative;">
                        <input type="text" id="searchQuery" placeholder="è¾“å…¥å…³é”®è¯æœç´¢å›¾ç‰‡..." style="width: 100%; padding-right: 100px;">
                        <button type="button" onclick="performSearch()" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">æœç´¢</button>
                    </div>
                    <div id="searchSuggestions" style="position: absolute; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; display: none; max-height: 200px; overflow-y: auto;"></div>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" onclick="showAllImages()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">æ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡</button>
                </div>
            </div>
            
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-group">
                    <label for="searchCategory">åˆ†ç±»</label>
                    <select id="searchCategory" onchange="performSearch()">
                        <option value="">æ‰€æœ‰åˆ†ç±»</option>
                        <option value="landscape">é£æ™¯</option>
                        <option value="anime">åŠ¨æ¼«</option>
                        <option value="beauty">ç¾å¥³</option>
                        <option value="nature">è‡ªç„¶</option>
                        <option value="city">åŸå¸‚</option>
                        <option value="art">è‰ºæœ¯</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="searchOrientation">æ–¹å‘</label>
                    <select id="searchOrientation" onchange="performSearch()">
                        <option value="">æ‰€æœ‰æ–¹å‘</option>
                        <option value="landscape">æ¨ªå‘</option>
                        <option value="portrait">çºµå‘</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="searchType">ç±»å‹</label>
                    <select id="searchType" onchange="performSearch()">
                        <option value="">æ‰€æœ‰ç±»å‹</option>
                        <option value="local">æœ¬åœ°å›¾ç‰‡</option>
                        <option value="url">URLå›¾ç‰‡</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="searchSort">æ’åº</label>
                    <select id="searchSort" onchange="performSearch()">
                        <option value="newest">æœ€æ–°ä¸Šä¼ </option>
                        <option value="oldest">æœ€æ—©ä¸Šä¼ </option>
                        <option value="random">éšæœºæ’åº</option>
                    </select>
                </div>
            </div>
            
            
            <!-- æœç´¢ç»“æœç»Ÿè®¡ -->
            <div id="searchStats" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span id="searchResultCount"></span>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span>æ¯é¡µæ˜¾ç¤º:</span>
                        <select id="searchLimit" onchange="performSearch()" style="padding: 4px 8px;">
                            <option value="12">12</option>
                            <option value="24">24</option>
                            <option value="36">36</option>
                            <option value="48">48</option>
                        </select>
                    </div>
                </div>
                
                <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
                <div id="batchActions" style="display: flex; gap: 10px; align-items: center; padding: 10px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="selectAllImages" onchange="toggleSelectAll()" style="transform: scale(1.2);">
                        <label for="selectAllImages" style="font-weight: bold; color: #495057;">å…¨é€‰</label>
                    </div>
                    <div style="border-left: 1px solid #dee2e6; height: 20px;"></div>
                    <span id="selectedCount" style="color: #6c757d; font-size: 14px;">å·²é€‰æ‹© 0 å¼ å›¾ç‰‡</span>
                    <div style="margin-left: auto; display: flex; gap: 8px;">
                        <button id="batchDeleteBtn" onclick="showBatchDeleteOptions()" disabled 
                                style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; opacity: 0.5;">
                            æ‰¹é‡åˆ é™¤
                        </button>
                        <button id="batchEditBtn" onclick="showBatchEditOptions()" disabled 
                                style="padding: 6px 12px; background: #ffc107; color: #212529; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; opacity: 0.5;">
                            æ‰¹é‡ç¼–è¾‘
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- æœç´¢ç»“æœ -->
            <div id="searchResults"></div>
            
            <!-- åˆ†é¡µå¯¼èˆª -->
            <div id="searchPagination"></div>
        </div>
        
        <div id="manageTab" class="tab-content">
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-group">
                    <label for="filterCategory">ç­›é€‰åˆ†ç±»</label>
                    <select id="filterCategory" onchange="loadImages(1)">
                        <option value="">æ‰€æœ‰åˆ†ç±»</option>
                        <option value="landscape">é£æ™¯</option>
                        <option value="anime">åŠ¨æ¼«</option>
                        <option value="beauty">ç¾å¥³</option>
                        <option value="nature">è‡ªç„¶</option>
                        <option value="city">åŸå¸‚</option>
                        <option value="art">è‰ºæœ¯</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterOrientation">ç­›é€‰æ–¹å‘</label>
                    <select id="filterOrientation" onchange="loadImages(1)">
                        <option value="">æ‰€æœ‰æ–¹å‘</option>
                        <option value="landscape">æ¨ªå±</option>
                        <option value="portrait">ç«–å±</option>
                    </select>
                </div>
            </div>
            
            <!-- ç¼©ç•¥å›¾ç®¡ç†å·¥å…·æ  -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6;">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <span style="font-weight: 600; color: #333;">ç¼©ç•¥å›¾ç®¡ç†:</span>
                    <button class="btn btn-secondary" onclick="generateMissingThumbnails()">ç”Ÿæˆç¼ºå¤±ç¼©ç•¥å›¾</button>
                    <button class="btn btn-secondary" onclick="loadThumbnailStats()">æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯</button>
                    <span id="thumbnailStats" style="color: #666; font-size: 14px;"></span>
                </div>
            </div>
            
            <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
            <div id="batchToolbar" class="batch-toolbar" style="display: none;">
                <div class="batch-actions">
                    <button class="btn btn-secondary" onclick="selectAllImages()">å…¨é€‰</button>
                    <button class="btn btn-secondary" onclick="deselectAllImages()">å–æ¶ˆå…¨é€‰</button>
                    <select id="batchCategory">
                        <option value="">æ‰¹é‡ä¿®æ”¹åˆ†ç±»</option>
                        <option value="landscape">é£æ™¯</option>
                        <option value="anime">åŠ¨æ¼«</option>
                        <option value="beauty">ç¾å¥³</option>
                        <option value="nature">è‡ªç„¶</option>
                        <option value="city">åŸå¸‚</option>
                        <option value="art">è‰ºæœ¯</option>
                    </select>
                    <button class="btn btn-warning" onclick="batchUpdateCategory()">åº”ç”¨åˆ†ç±»</button>
                    <button class="btn btn-danger" onclick="batchDeleteImages()">æ‰¹é‡åˆ é™¤</button>
                    <span id="selectedCount" class="selected-count">å·²é€‰æ‹© 0 é¡¹</span>
                </div>
            </div>
            
            <div class="pagination-info" style="margin-bottom: 15px; text-align: center; color: #666;">
                <span id="paginationInfo">åŠ è½½ä¸­...</span>
            </div>
            
            <div id="imagesContainer" class="images-grid">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            
            <div class="pagination" id="pagination" style="display: none;">
                <button class="btn btn-secondary" id="prevBtn" onclick="loadPrevPage()" disabled>ä¸Šä¸€é¡µ</button>
                <div class="page-numbers" id="pageNumbers"></div>
                <button class="btn btn-secondary" id="nextBtn" onclick="loadNextPage()" disabled>ä¸‹ä¸€é¡µ</button>
            </div>
        </div>
        
        
        <div id="usersTab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>è´¦å·ç®¡ç†</h2>
                <button class="btn" onclick="showCreateUserModal()">æ·»åŠ è´¦å·</button>
            </div>
            
            <div id="usersContainer" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
        
        <div id="securityTab" class="tab-content">
            <h2>å®‰å…¨è®¾ç½®</h2>
            
            <div style="margin-bottom: 30px;">
                <h3>ä¿®æ”¹å¯†ç </h3>
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <form id="changePasswordForm" style="max-width: 400px;">
                        <div class="form-group">
                            <label for="currentPassword">å½“å‰å¯†ç </label>
                            <input type="password" id="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">æ–°å¯†ç </label>
                            <input type="password" id="newPassword" required>
                            <small style="color: #666; font-size: 12px;">å¯†ç è‡³å°‘6ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—</small>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">ç¡®è®¤æ–°å¯†ç </label>
                            <input type="password" id="confirmPassword" required>
                        </div>
                        <button type="submit" class="btn">ä¿®æ”¹å¯†ç </button>
                    </form>
                </div>
            </div>
            
            <div style="margin-bottom: 30px;">
                <h3>ğŸ“§ ä¿®æ”¹é‚®ç®±</h3>
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <form id="changeEmailForm" style="max-width: 400px;">
                        <div class="form-group">
                            <label for="currentEmail">å½“å‰é‚®ç®±</label>
                            <input type="email" id="currentEmail" readonly style="background: #f8f9fa;" placeholder="è·å–ä¸­...">
                            <small style="color: #666; font-size: 12px;">å½“å‰ç»‘å®šçš„é‚®ç®±åœ°å€</small>
                        </div>
                        <div class="form-group">
                            <label for="newEmail">æ–°é‚®ç®±</label>
                            <input type="email" id="newEmail" required placeholder="è¯·è¾“å…¥æ–°çš„é‚®ç®±åœ°å€">
                            <small style="color: #666; font-size: 12px;">è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€</small>
                        </div>
                        <div class="form-group">
                            <label for="emailPassword">ç¡®è®¤å¯†ç </label>
                            <input type="password" id="emailPassword" required placeholder="è¯·è¾“å…¥å½“å‰å¯†ç ç¡®è®¤èº«ä»½">
                            <small style="color: #666; font-size: 12px;">è¾“å…¥å½“å‰å¯†ç ä»¥ç¡®è®¤èº«ä»½</small>
                        </div>
                        <button type="submit" class="btn">ä¿®æ”¹é‚®ç®±</button>
                    </form>
                </div>
            </div>
            
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>è®¿é—®æ§åˆ¶è§„åˆ™</h3>
                    <button class="btn" onclick="showCreateRuleModal()">æ·»åŠ è§„åˆ™</button>
                </div>
                
                <div id="accessRulesContainer" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>ğŸ”’ IPé™åˆ¶ç®¡ç†</h3>
                    <div>
                        <button class="btn" onclick="refreshBlockedIPs()" style="margin-right: 10px;">åˆ·æ–°</button>
                        <button class="btn btn-warning" onclick="clearAllIPRestrictions()">æ¸…é™¤æ‰€æœ‰é™åˆ¶</button>
                    </div>
                </div>
                
                <div id="ipManagementContainer" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="margin-bottom: 15px;">
                        <strong>å½“å‰è¢«é™åˆ¶çš„IPåœ°å€ï¼š</strong>
                        <span id="blockedIPCount" style="color: #dc3545;">0</span> ä¸ª
                    </div>
                    
                    <div id="blockedIPsList">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                        <h4 style="margin-top: 0;">ç´§æ€¥æ¸…é™¤IPé™åˆ¶</h4>
                        <p style="color: #666; font-size: 14px;">å¦‚æœä½ çš„IPè¢«è¯¯å°ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è§£é™¤ï¼š</p>
                        <ul style="color: #666; font-size: 14px; margin: 10px 0;">
                            <li>é‡å¯æœåŠ¡å™¨ï¼ˆæœ€ç®€å•çš„æ–¹æ³•ï¼‰</li>
                            <li>ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·ï¼š<code>node ip-management.js clear</code></li>
                            <li>ç­‰å¾…è‡ªåŠ¨è§£é™¤ï¼ˆ1å°æ—¶åè‡ªåŠ¨æ¸…é™¤ï¼‰</li>
                        </ul>
                        <button class="btn btn-danger" onclick="emergencyClearIP()">ğŸš¨ ç´§æ€¥æ¸…é™¤æ‰€æœ‰IPé™åˆ¶</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="systemTab" class="tab-content">
            <h2>ç³»ç»Ÿè®¾ç½®</h2>
            
            <div style="margin-bottom: 30px;">
                <h3>æ³¨å†Œæ§åˆ¶</h3>
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <form id="registrationForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="registrationEnabled">å…è®¸æ³¨å†Œ</label>
                                <select id="registrationEnabled" name="registration_enabled">
                                    <option value="true">å¼€å¯</option>
                                    <option value="false">å…³é—­</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="registrationApproval">éœ€è¦å®¡æ‰¹</label>
                                <select id="registrationApproval" name="registration_require_approval">
                                    <option value="false">å¦</option>
                                    <option value="true">æ˜¯</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="maxUsers">ç”¨æˆ·æ•°é‡é™åˆ¶</label>
                                <input type="number" id="maxUsers" name="max_users" min="1" max="100000" value="1000" placeholder="æœ€å¤§ç”¨æˆ·æ•°">
                            </div>
                            <div class="form-group">
                                <label for="maintenanceMode">ç»´æŠ¤æ¨¡å¼</label>
                                <select id="maintenanceMode" name="site_maintenance">
                                    <option value="false">å…³é—­</option>
                                    <option value="true">å¼€å¯</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="registrationMessage">æ³¨å†Œé¡µé¢æ¶ˆæ¯</label>
                            <textarea id="registrationMessage" name="registration_message" rows="3" 
                                placeholder="æ˜¾ç¤ºåœ¨æ³¨å†Œé¡µé¢çš„æ¬¢è¿æ¶ˆæ¯" 
                                style="width: 100%; padding: 12px 15px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 16px; resize: vertical; min-height: 80px;"></textarea>
                        </div>
                        
                        <button type="submit" class="btn" style="transition: all 0.3s ease;">ä¿å­˜è®¾ç½®</button>
                    </form>
                </div>
            </div>
            
            <div>
                <h3>ç³»ç»Ÿä¿¡æ¯</h3>
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div id="systemInfoContainer">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åˆ›å»ºç”¨æˆ·æ¨¡æ€æ¡† -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateUserModal()">&times;</span>
            <h2>æ·»åŠ æ–°è´¦å·</h2>
            
            <!-- é”™è¯¯æç¤ºåŒºåŸŸ -->
            <div class="alert alert-error" id="createUserErrorAlert" style="display: none;"></div>
            
            <form id="createUserForm">
                <div class="form-group">
                    <label for="newUsername">ç”¨æˆ·å</label>
                    <input type="text" id="newUsername" required>
                    <small style="color: #666; font-size: 12px;">3-20ä½ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿</small>
                </div>
                <div class="form-group">
                    <label for="newUserPassword">å¯†ç </label>
                    <input type="password" id="newUserPassword" required>
                    <small style="color: #666; font-size: 12px;">å¯†ç è‡³å°‘6ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—</small>
                </div>
                <div class="form-group">
                    <label for="newUserEmail">é‚®ç®±</label>
                    <input type="email" id="newUserEmail">
                    <small style="color: #666; font-size: 12px;">å¯é€‰ï¼Œç”¨äºæ‰¾å›å¯†ç ç­‰åŠŸèƒ½</small>
                </div>
                <div class="form-group">
                    <label for="newUserRole">è§’è‰²</label>
                    <select id="newUserRole" required>
                        <option value="user">æ™®é€šç”¨æˆ·</option>
                        <option value="admin">ç®¡ç†å‘˜</option>
                    </select>
                    <small style="color: #666; font-size: 12px;">
                        æ™®é€šç”¨æˆ·ï¼šåªèƒ½æŸ¥çœ‹å’Œä½¿ç”¨API<br>
                        ç®¡ç†å‘˜ï¼šæ‹¥æœ‰å®Œæ•´ç®¡ç†æƒé™
                    </small>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateUserModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn">åˆ›å»ºè´¦å·</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- åˆ›å»ºè®¿é—®è§„åˆ™æ¨¡æ€æ¡† -->
    <div id="createRuleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateRuleModal()">&times;</span>
            <h2>æ·»åŠ è®¿é—®æ§åˆ¶è§„åˆ™</h2>
            <form id="createRuleForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="ruleType">ç±»å‹</label>
                        <select id="ruleType" required>
                            <option value="ip">IPåœ°å€</option>
                            <option value="domain">åŸŸå</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ruleAction">åŠ¨ä½œ</label>
                        <select id="ruleAction" required>
                            <option value="allow">å…è®¸</option>
                            <option value="deny">æ‹’ç»</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="ruleValue">å€¼</label>
                    <input type="text" id="ruleValue" required placeholder="å¦‚: 192.168.1.*, example.com">
                    <small style="color: #666; font-size: 12px;">æ”¯æŒé€šé…ç¬¦ï¼Œå¦‚: 192.168.*.* æˆ– *.example.com</small>
                </div>
                <div class="form-group">
                    <label for="ruleDescription">æè¿°</label>
                    <input type="text" id="ruleDescription" placeholder="è§„åˆ™æè¿°">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateRuleModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn">æ·»åŠ è§„åˆ™</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>ç¼–è¾‘å›¾ç‰‡</h2>
            <form id="editForm">
                <input type="hidden" id="editImageId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editCategory">åˆ†ç±»</label>
                        <select id="editCategory" required>
                            <option value="landscape">é£æ™¯</option>
                            <option value="anime">åŠ¨æ¼«</option>
                            <option value="beauty">ç¾å¥³</option>
                            <option value="nature">è‡ªç„¶</option>
                            <option value="city">åŸå¸‚</option>
                            <option value="art">è‰ºæœ¯</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editOrientation">æ–¹å‘</label>
                        <select id="editOrientation" required>
                            <option value="landscape">æ¨ªå±</option>
                            <option value="portrait">ç«–å±</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editImageFile">æ›´æ¢å›¾ç‰‡</label>
                    <input type="file" id="editImageFile" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="editImageUrl">æˆ–è¾“å…¥æ–°URL</label>
                    <input type="url" id="editImageUrl" placeholder="https://example.com/image.jpg">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn">ä¿å­˜æ›´æ”¹</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentImages = [];
        let currentPage = 1;
        let totalPages = 1;
        let currentPagination = null;
        let currentUser = null;
        
        // æœç´¢ç›¸å…³å˜é‡
        let searchCurrentPage = 1;
        let searchTotalPages = 1;
        let searchCurrentQuery = '';
        let searchTimeout = null;
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });
        
        async function checkLoginStatus() {
            try {
                const response = await fetch('/auth/status', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (!data.isLoggedIn) {
                    window.location.href = '/login';
                    return;
                }
                
                currentUser = data.user;
                document.getElementById('userInfo').textContent = `æ¬¢è¿ï¼Œ${data.user.username}`;
                
                // å¼ºåˆ¶åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
                setTimeout(() => {
                    forceUpdateStats();
                }, 500);
                
                // åˆå§‹åŒ–ç³»ç»Ÿè®¾ç½®ï¼ˆä¸ºç³»ç»Ÿè®¾ç½®é¡µé¢åšå‡†å¤‡ï¼‰
                setTimeout(() => {
                    loadSystemSettings();
                }, 200);
            } catch (error) {
                console.error('Check login status failed:', error);
                window.location.href = '/login';
            }
        }
        
        async function logout() {
            try {
                const response = await fetch('/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    showAlert('ç™»å‡ºå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('Logout error:', error);
                showAlert('ç½‘ç»œé”™è¯¯', 'error');
            }
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'manage') {
                loadImages(1);
                loadThumbnailStats();
            } else if (tabName === 'search') {
                setupSearchEventListeners();
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'security') {
                loadAccessRules();
            } else if (tabName === 'system') {
                loadSystemSettings();
                loadSystemInfo();
            }
        }
        
        function showAlert(message, type) {
            const alertId = type === 'success' ? 'successAlert' : 'errorAlert';
            const alert = document.getElementById(alertId);
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
        
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            const progressContainer = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            // é˜²æ­¢é‡å¤æäº¤
            if (submitBtn.disabled) return;
            
            const formData = new FormData();
            const category = document.getElementById('category').value;
            const orientation = document.getElementById('orientation').value;
            const imageFile = document.getElementById('imageFile').files[0];
            const imageUrl = document.getElementById('imageUrl').value;
            
            if (!category || !orientation) {
                showAlert('è¯·é€‰æ‹©åˆ†ç±»å’Œæ–¹å‘', 'error');
                return;
            }
            
            if (!imageFile && !imageUrl) {
                showAlert('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶æˆ–è¾“å…¥å›¾ç‰‡URL', 'error');
                return;
            }
            
            // æ–‡ä»¶å¤§å°æ£€æŸ¥
            if (imageFile && imageFile.size > 10 * 1024 * 1024) { // 10MBé™åˆ¶
                showAlert('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB', 'error');
                return;
            }
            
            formData.append('category', category);
            formData.append('orientation', orientation);
            
            if (imageFile) {
                formData.append('image', imageFile);
            }
            
            if (imageUrl) {
                formData.append('url', imageUrl);
            }
            
            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºè¿›åº¦
            submitBtn.disabled = true;
            submitBtn.textContent = 'ä¸Šä¼ ä¸­...';
            
            // æ˜¾ç¤ºè¿›åº¦æ¡ï¼ˆä»…æ–‡ä»¶ä¸Šä¼ æ—¶ï¼‰
            if (imageFile) {
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                progressText.textContent = 'å‡†å¤‡ä¸Šä¼ ...';
            }
            
            try {
                // ä½¿ç”¨XMLHttpRequestä»¥æ”¯æŒè¿›åº¦æ˜¾ç¤º
                const uploadPromise = new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    
                    // ä¸Šä¼ è¿›åº¦ç›‘å¬ï¼ˆä»…æ–‡ä»¶ä¸Šä¼ æ—¶ï¼‰
                    if (imageFile) {
                        xhr.upload.addEventListener('progress', (e) => {
                            if (e.lengthComputable) {
                                const percentComplete = (e.loaded / e.total) * 100;
                                progressBar.style.width = percentComplete + '%';
                                progressText.textContent = `ä¸Šä¼ ä¸­... ${Math.round(percentComplete)}%`;
                            }
                        });
                    }
                    
                    xhr.addEventListener('load', () => {
                        if (xhr.status === 200) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                resolve(response);
                            } catch (e) {
                                reject(new Error('å“åº”è§£æå¤±è´¥'));
                            }
                        } else {
                            try {
                                const error = JSON.parse(xhr.responseText);
                                reject(new Error(error.error || 'ä¸Šä¼ å¤±è´¥'));
                            } catch (e) {
                                reject(new Error('ä¸Šä¼ å¤±è´¥'));
                            }
                        }
                    });
                    
                    xhr.addEventListener('error', () => {
                        reject(new Error('ç½‘ç»œé”™è¯¯'));
                    });
                    
                    xhr.open('POST', '/api/images');
                    xhr.send(formData);
                });
                
                const result = await uploadPromise;
                
                // ä¸Šä¼ æˆåŠŸ
                if (imageFile) {
                    progressBar.style.width = '100%';
                    progressText.textContent = 'ä¸Šä¼ å®Œæˆï¼';
                }
                
                showAlert('å›¾ç‰‡æ·»åŠ æˆåŠŸï¼', 'success');
                document.getElementById('uploadForm').reset();
                
                // éšè—è¿›åº¦æ¡
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 1000);
                
                // å»¶è¿Ÿæ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œé¿å…é˜»å¡UI
                setTimeout(() => {
                    updateStatsOptimized();
                }, 100);
                
                // å¦‚æœå½“å‰åœ¨ç®¡ç†å›¾ç‰‡æ ‡ç­¾é¡µï¼Œä¼˜åŒ–åˆ·æ–°
                if (document.getElementById('manageTab').classList.contains('active')) {
                    setTimeout(() => {
                        loadImages(currentPage);
                    }, 200);
                }
                
            } catch (error) {
                showAlert(error.message || 'ç½‘ç»œé”™è¯¯', 'error');
                progressContainer.style.display = 'none';
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
        
        async function loadImages(page = 1) {
            const category = document.getElementById('filterCategory').value;
            const orientation = document.getElementById('filterOrientation').value;
            
            let url = '/api/images';
            const params = new URLSearchParams();
            params.append('page', page);
            params.append('limit', '12');
            if (category) params.append('category', category);
            if (orientation) params.append('orientation', orientation);
            url += '?' + params.toString();
            
            try {
                document.getElementById('imagesContainer').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
                
                const response = await fetch(url);
                const result = await response.json();
                
                currentImages = result.data;
                currentPage = result.pagination.page;
                totalPages = result.pagination.totalPages;
                currentPagination = result.pagination;
                
                displayImages(result.data);
                updatePaginationInfo(result.pagination);
                updatePaginationControls(result.pagination);
            } catch (error) {
                document.getElementById('imagesContainer').innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
            }
        }
        
        function displayImages(images) {
            const container = document.getElementById('imagesContainer');
            
            if (images.length === 0) {
                container.innerHTML = '<div class="loading">æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡</div>';
                document.getElementById('pagination').style.display = 'none';
                return;
            }
            
            // ä½¿ç”¨DocumentFragmentæé«˜æ€§èƒ½
            const fragment = document.createDocumentFragment();
            
            images.forEach(image => {
                // æ„å»ºç¼©ç•¥å›¾URL
                let thumbnailUrl = '';
                if (image.is_local && image.thumbnail) {
                    // ä½¿ç”¨ç¼©ç•¥å›¾æœåŠ¡ï¼Œé»˜è®¤ä½¿ç”¨mediumå°ºå¯¸
                    thumbnailUrl = `/thumbnails/medium/${image.thumbnail}`;
                } else if (image.is_local && image.filename) {
                    // å¦‚æœæ²¡æœ‰ç¼©ç•¥å›¾ä½†æœ‰æ–‡ä»¶åï¼Œå°è¯•ç”Ÿæˆmediumå°ºå¯¸ç¼©ç•¥å›¾
                    thumbnailUrl = `/thumbnails/medium/medium_${image.filename}`;
                } else if (image.is_local) {
                    // å›é€€åˆ°åŸå›¾
                    thumbnailUrl = `/api/images/${image.id}`;
                } else {
                    // å¯¹äºURLå›¾ç‰‡ï¼Œä½¿ç”¨åŸå›¾ï¼Œæ·»åŠ é€‚å½“çš„ä»£ç†å’Œç¼“å­˜å‚æ•°
                    if (image.url && image.url.includes('unsplash.com')) {
                        // å¯¹äºUnsplashå›¾ç‰‡ï¼Œæ·»åŠ å°ºå¯¸å‚æ•°ä»¥è·å¾—æ›´å°çš„å›¾ç‰‡ä½œä¸ºç¼©ç•¥å›¾
                        thumbnailUrl = image.url.replace(/w=\d+&h=\d+/, 'w=300&h=300');
                    } else {
                        thumbnailUrl = image.url;
                    }
                }
                
                const imageCard = document.createElement('div');
                imageCard.className = 'image-card';
                imageCard.setAttribute('data-image-id', image.id);
                
                imageCard.innerHTML = `
                    <div class="thumbnail-container">
                        <input type="checkbox" class="image-checkbox" onchange="toggleImageSelection(${image.id}, this)">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxjaXJjbGUgY3g9IjE1MCIgY3k9IjEwMCIgcj0iMjAiIGZpbGw9IiNEMUQ1REIiLz4KPHRleHQgeD0iMTUwIiB5PSIxNDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNjY2NjY2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7liqDovb3kuK08L3RleHQ+Cjwvc3ZnPgo=" 
                             alt="${image.original_name || 'å›¾ç‰‡'}" 
                             class="thumbnail placeholder-image"
                             data-src="${thumbnailUrl}"
                             data-image-id="${image.id}"
                             data-type="${image.is_local ? 'local' : 'url'}"
                             loading="lazy">
                        <div class="thumbnail-overlay">
                            <span class="image-id">#${image.id}</span>
                        </div>
                    </div>
                    <div class="image-card-content">
                        <div class="image-card-title">${image.original_name || 'URLå›¾ç‰‡'}</div>
                        <div class="image-card-meta">
                            åˆ†ç±»: ${getCategoryName(image.category)} | 
                            æ–¹å‘: ${image.orientation === 'landscape' ? 'æ¨ªå±' : 'ç«–å±'} |
                            ${image.is_local ? 'æœ¬åœ°' : 'URL'}
                        </div>
                        <div class="image-card-actions">
                            <button class="btn btn-secondary" onclick="editImage(${image.id})">ç¼–è¾‘</button>
                            <button class="btn btn-danger" onclick="deleteImage(${image.id})">åˆ é™¤</button>
                        </div>
                    </div>
                `;
                
                fragment.appendChild(imageCard);
            });
            
            // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ æ–°å†…å®¹
            container.innerHTML = '';
            container.appendChild(fragment);
            
            // åˆå§‹åŒ–æ‡’åŠ è½½
            initializeLazyLoading();
            
            // æ˜¾ç¤ºæˆ–éšè—æ‰¹é‡æ“ä½œå·¥å…·æ 
            updateBatchToolbarVisibility();
        }
        
        // æ‡’åŠ è½½å®ç°
        let imageObserver = null;
        
        function initializeLazyLoading() {
            // å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒIntersection Observerï¼Œç›´æ¥åŠ è½½æ‰€æœ‰å›¾ç‰‡
            if (!('IntersectionObserver' in window)) {
                loadAllImages();
                return;
            }
            
            // åˆ›å»ºIntersection Observer
            if (imageObserver) {
                imageObserver.disconnect();
            }
            
            imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        loadImage(img);
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px 0px', // æå‰50pxå¼€å§‹åŠ è½½
                threshold: 0.1
            });
            
            // è§‚å¯Ÿæ‰€æœ‰å ä½ç¬¦å›¾ç‰‡
            const placeholderImages = document.querySelectorAll('.placeholder-image');
            placeholderImages.forEach(img => {
                imageObserver.observe(img);
            });
        }
        
        function loadImage(img) {
            const src = img.getAttribute('data-src');
            const imageId = img.getAttribute('data-image-id');
            const type = img.getAttribute('data-type');
            
            if (src) {
                // æ·»åŠ åŠ è½½çŠ¶æ€
                img.classList.add('loading');
                
                // åˆ›å»ºæ–°çš„å›¾ç‰‡å¯¹è±¡è¿›è¡Œé¢„åŠ è½½
                const newImg = new Image();
                
                newImg.onload = function() {
                    img.src = src;
                    img.classList.remove('placeholder-image', 'loading');
                    img.classList.add('loaded');
                };
                
                newImg.onerror = function() {
                    handleThumbnailError(img, imageId, type);
                    img.classList.remove('placeholder-image', 'loading');
                };
                
                newImg.src = src;
            }
        }
        
        function loadAllImages() {
            const placeholderImages = document.querySelectorAll('.placeholder-image');
            placeholderImages.forEach(img => {
                loadImage(img);
            });
        }
        
        // æ‰¹é‡æ“ä½œç›¸å…³å˜é‡å’Œå‡½æ•°
        let selectedImages = new Set();
        
        function toggleImageSelection(imageId, checkbox) {
            const imageCard = checkbox.closest('.image-card');
            
            if (checkbox.checked) {
                selectedImages.add(imageId);
                imageCard.classList.add('selected');
            } else {
                selectedImages.delete(imageId);
                imageCard.classList.remove('selected');
            }
            
            updateSelectedCount();
            updateBatchToolbarVisibility();
        }
        
        function selectAllImages() {
            const checkboxes = document.querySelectorAll('.image-checkbox');
            checkboxes.forEach(checkbox => {
                if (!checkbox.checked) {
                    checkbox.checked = true;
                    toggleImageSelection(parseInt(checkbox.closest('.image-card').dataset.imageId), checkbox);
                }
            });
        }
        
        function deselectAllImages() {
            const checkboxes = document.querySelectorAll('.image-checkbox');
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    checkbox.checked = false;
                    toggleImageSelection(parseInt(checkbox.closest('.image-card').dataset.imageId), checkbox);
                }
            });
        }
        
        function updateSelectedCount() {
            const countEl = document.getElementById('selectedCount');
            countEl.textContent = `å·²é€‰æ‹© ${selectedImages.size} é¡¹`;
        }
        
        function updateBatchToolbarVisibility() {
            const toolbar = document.getElementById('batchToolbar');
            if (selectedImages.size > 0) {
                toolbar.style.display = 'block';
            } else {
                toolbar.style.display = 'none';
            }
        }
        
        async function batchUpdateCategory() {
            const newCategory = document.getElementById('batchCategory').value;
            if (!newCategory) {
                alert('è¯·é€‰æ‹©è¦ä¿®æ”¹çš„åˆ†ç±»');
                return;
            }
            
            if (selectedImages.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦ä¿®æ”¹çš„å›¾ç‰‡');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦å°†é€‰ä¸­çš„ ${selectedImages.size} å¼ å›¾ç‰‡çš„åˆ†ç±»ä¿®æ”¹ä¸º ${getCategoryName(newCategory)} å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const promises = Array.from(selectedImages).map(imageId => 
                    fetch(`/api/images/${imageId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ category: newCategory })
                    })
                );
                
                await Promise.all(promises);
                
                alert('æ‰¹é‡ä¿®æ”¹åˆ†ç±»æˆåŠŸï¼');
                deselectAllImages();
                loadImages(currentPagination?.page || 1);
                loadStats();
            } catch (error) {
                alert('æ‰¹é‡ä¿®æ”¹åˆ†ç±»å¤±è´¥ï¼š' + error.message);
            }
        }
        
        async function batchDeleteImages() {
            if (selectedImages.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å›¾ç‰‡');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedImages.size} å¼ å›¾ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }
            
            try {
                const promises = Array.from(selectedImages).map(imageId => 
                    fetch(`/api/images/${imageId}`, {
                        method: 'DELETE'
                    })
                );
                
                await Promise.all(promises);
                
                alert('æ‰¹é‡åˆ é™¤æˆåŠŸï¼');
                deselectAllImages();
                loadImages(currentPagination?.page || 1);
                loadStats();
            } catch (error) {
                alert('æ‰¹é‡åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }
        
        function updatePaginationInfo(pagination) {
            const info = document.getElementById('paginationInfo');
            const start = (pagination.page - 1) * pagination.limit + 1;
            const end = Math.min(pagination.page * pagination.limit, pagination.total);
            info.textContent = `æ˜¾ç¤º ${start}-${end} æ¡ï¼Œå…± ${pagination.total} æ¡è®°å½•ï¼ˆç¬¬ ${pagination.page}/${pagination.totalPages} é¡µï¼‰`;
        }
        
        function updatePaginationControls(pagination) {
            const paginationEl = document.getElementById('pagination');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pageNumbers = document.getElementById('pageNumbers');
            
            if (pagination.totalPages <= 1) {
                paginationEl.style.display = 'none';
                return;
            }
            
            paginationEl.style.display = 'flex';
            
            // æ›´æ–°ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µæŒ‰é’®
            prevBtn.disabled = !pagination.hasPrev;
            nextBtn.disabled = !pagination.hasNext;
            
            // ç”Ÿæˆé¡µç 
            pageNumbers.innerHTML = '';
            const maxVisible = 5;
            let startPage = Math.max(1, pagination.page - Math.floor(maxVisible / 2));
            let endPage = Math.min(pagination.totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            // ç¬¬ä¸€é¡µ
            if (startPage > 1) {
                pageNumbers.appendChild(createPageButton(1, pagination.page));
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'page-number disabled';
                    pageNumbers.appendChild(ellipsis);
                }
            }
            
            // é¡µç èŒƒå›´
            for (let i = startPage; i <= endPage; i++) {
                pageNumbers.appendChild(createPageButton(i, pagination.page));
            }
            
            // æœ€åä¸€é¡µ
            if (endPage < pagination.totalPages) {
                if (endPage < pagination.totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'page-number disabled';
                    pageNumbers.appendChild(ellipsis);
                }
                pageNumbers.appendChild(createPageButton(pagination.totalPages, pagination.page));
            }
        }
        
        function createPageButton(pageNum, currentPage) {
            const button = document.createElement('span');
            button.textContent = pageNum;
            button.className = `page-number ${pageNum === currentPage ? 'active' : ''}`;
            button.onclick = () => loadImages(pageNum);
            return button;
        }
        
        function loadPrevPage() {
            if (currentPage > 1) {
                loadImages(currentPage - 1);
            }
        }
        
        function loadNextPage() {
            if (currentPage < totalPages) {
                loadImages(currentPage + 1);
            }
        }
        
        function getCategoryName(category) {
            const names = {
                'landscape': 'é£æ™¯',
                'anime': 'åŠ¨æ¼«',
                'beauty': 'ç¾å¥³',
                'nature': 'è‡ªç„¶',
                'city': 'åŸå¸‚',
                'art': 'è‰ºæœ¯'
            };
            return names[category] || category;
        }
        
        function editImage(id) {
            const image = currentImages.find(img => img.id === id);
            if (!image) return;
            
            document.getElementById('editImageId').value = id;
            document.getElementById('editCategory').value = image.category;
            document.getElementById('editOrientation').value = image.orientation;
            document.getElementById('editImageFile').value = '';
            document.getElementById('editImageUrl').value = image.url || '';
            
            document.getElementById('editModal').style.display = 'block';
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('editImageId').value;
            const formData = new FormData();
            
            formData.append('category', document.getElementById('editCategory').value);
            formData.append('orientation', document.getElementById('editOrientation').value);
            
            const imageFile = document.getElementById('editImageFile').files[0];
            const imageUrl = document.getElementById('editImageUrl').value;
            
            if (imageFile) {
                formData.append('image', imageFile);
            }
            
            if (imageUrl) {
                formData.append('url', imageUrl);
            }
            
            try {
                const response = await fetch(`/api/images/${id}`, {
                    method: 'PUT',
                    body: formData
                });
                
                if (response.ok) {
                    showAlert('å›¾ç‰‡æ›´æ–°æˆåŠŸï¼', 'success');
                    closeEditModal();
                    loadImages(currentPage);
                    updateStats();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'æ›´æ–°å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
            }
        });
        
        async function deleteImage(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/images/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('å›¾ç‰‡åˆ é™¤æˆåŠŸï¼', 'success');
                    loadImages(currentPage);
                    updateStats();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
            }
        }
        
        
        // ç”¨æˆ·ç®¡ç†åŠŸèƒ½
        async function loadUsers() {
            try {
                const response = await fetch('/auth/users', {
                    credentials: 'include'
                });
                const users = await response.json();
                
                displayUsers(users);
            } catch (error) {
                console.error('Load users error:', error);
                document.getElementById('usersContainer').innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
            }
        }
        
        function displayUsers(users) {
            const container = document.getElementById('usersContainer');
            
            if (users.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— ç”¨æˆ·</div>';
                return;
            }
            
            const table = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">ç”¨æˆ·å</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">é‚®ç®±</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">è§’è‰²</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">çŠ¶æ€</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">æœ€åç™»å½•</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr style="border-bottom: 1px solid #e1e5e9;">
                                <td style="padding: 12px;">${user.username}</td>
                                <td style="padding: 12px;">${user.email || '-'}</td>
                                <td style="padding: 12px;">${user.role}</td>
                                <td style="padding: 12px;">
                                    <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; ${user.is_active ? 'background: #d4edda; color: #155724;' : 'background: #f8d7da; color: #721c24;'}">
                                        ${user.is_active ? 'æ´»è·ƒ' : 'ç¦ç”¨'}
                                    </span>
                                </td>
                                <td style="padding: 12px;">${user.last_login ? new Date(user.last_login).toLocaleString() : 'ä»æœªç™»å½•'}</td>
                                <td style="padding: 12px;">
                                    ${user.id !== currentUser.id ? `
                                        <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                            <button class="btn ${user.is_active ? 'btn-warning' : 'btn-success'}" 
                                                    style="padding: 4px 8px; font-size: 12px;" 
                                                    onclick="toggleUserStatus(${user.id}, '${user.username}', ${user.is_active})">
                                                ${user.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                                            </button>
                                            <button class="btn btn-danger" 
                                                    style="padding: 4px 8px; font-size: 12px;" 
                                                    onclick="deleteUser(${user.id}, '${user.username}')"
                                                    ${user.role === 'admin' ? 'disabled title="ä¸èƒ½åˆ é™¤ç®¡ç†å‘˜è´¦æˆ·"' : ''}>
                                                åˆ é™¤
                                            </button>
                                        </div>
                                    ` : '<span style="color: #666; font-size: 12px;">å½“å‰ç”¨æˆ·</span>'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }
        
        function showCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'block';
            // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
            document.getElementById('createUserErrorAlert').style.display = 'none';
        }
        
        function closeCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'none';
            document.getElementById('createUserForm').reset();
            // æ¸…é™¤é”™è¯¯ä¿¡æ¯
            document.getElementById('createUserErrorAlert').style.display = 'none';
        }
        
        // åœ¨æ¨¡æ€æ¡†ä¸­æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showCreateUserError(message) {
            const errorAlert = document.getElementById('createUserErrorAlert');
            errorAlert.textContent = message;
            errorAlert.style.display = 'block';
            
            // è‡ªåŠ¨éšè—é”™è¯¯ä¿¡æ¯
            setTimeout(() => {
                errorAlert.style.display = 'none';
            }, 5000);
        }
        
        document.getElementById('createUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            // é˜²æ­¢é‡å¤æäº¤
            if (submitBtn.disabled) return;
            
            // è·å–è¡¨å•æ•°æ®
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const email = document.getElementById('newUserEmail').value.trim();
            const role = document.getElementById('newUserRole').value;
            
            // å®¢æˆ·ç«¯éªŒè¯
            if (!username || !password) {
                showCreateUserError('âŒ ç”¨æˆ·åå’Œå¯†ç æ˜¯å¿…å¡«é¡¹');
                return;
            }
            
            // éªŒè¯å¯†ç å¼ºåº¦
            if (password.length < 6) {
                showCreateUserError('âŒ å¯†ç é•¿åº¦è‡³å°‘6ä½');
                return;
            }
            
            if (!/(?=.*[a-zA-Z])(?=.*\d)/.test(password)) {
                showCreateUserError('âŒ å¯†ç å¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—');
                return;
            }
            
            // éªŒè¯ç”¨æˆ·åæ ¼å¼
            if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
                showCreateUserError('âŒ ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼Œé•¿åº¦3-20ä½');
                return;
            }
            
            // éªŒè¯é‚®ç®±æ ¼å¼ï¼ˆå¦‚æœå¡«å†™äº†ï¼‰
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showCreateUserError('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
                return;
            }
            
            // æ˜¾ç¤ºåˆ›å»ºçŠ¶æ€
            submitBtn.disabled = true;
            submitBtn.textContent = 'åˆ›å»ºä¸­...';
            submitBtn.style.opacity = '0.7';
            
            const formData = new FormData();
            formData.append('username', username);
            formData.append('password', password);
            formData.append('email', email);
            formData.append('role', role);
            
            try {
                const response = await fetch('/auth/users', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // æˆåŠŸæç¤º
                    const roleName = role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·';
                    showAlert(`ğŸ‰ ${roleName}è´¦æˆ·åˆ›å»ºæˆåŠŸï¼ç”¨æˆ·åï¼š${username}`, 'success');
                    
                    // ä¸´æ—¶æ”¹å˜æŒ‰é’®æ ·å¼è¡¨ç¤ºæˆåŠŸ
                    submitBtn.style.background = '#28a745';
                    submitBtn.textContent = 'âœ… åˆ›å»ºæˆåŠŸ';
                    
                    // 2ç§’åå…³é—­æ¨¡æ€æ¡†å¹¶æ¢å¤
                    setTimeout(() => {
                        closeCreateUserModal();
                        loadUsers(); // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                        submitBtn.style.background = '';
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = '';
                    }, 1500);
                } else {
                    showCreateUserError('âŒ ' + (data.error || 'åˆ›å»ºç”¨æˆ·å¤±è´¥'));
                    
                    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                    submitBtn.style.background = '#dc3545';
                    submitBtn.textContent = 'âŒ åˆ›å»ºå¤±è´¥';
                    
                    // 2ç§’åæ¢å¤æŒ‰é’®
                    setTimeout(() => {
                        submitBtn.style.background = '';
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = '';
                    }, 2000);
                }
            } catch (error) {
                showCreateUserError('ğŸŒ ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                submitBtn.style.background = '#dc3545';
                submitBtn.textContent = 'âŒ ç½‘ç»œé”™è¯¯';
                
                // 2ç§’åæ¢å¤æŒ‰é’®
                setTimeout(() => {
                    submitBtn.style.background = '';
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '';
                }, 2000);
            }
        });
        
        async function deleteUser(userId, username) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${username}" å—ï¼Ÿ\n\næ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤ç”¨æˆ·è´¦æˆ·ï¼Œæ— æ³•æ¢å¤ï¼`)) return;
            
            // æ‰¾åˆ°å¯¹åº”çš„åˆ é™¤æŒ‰é’®
            const deleteBtn = event.target;
            const originalText = deleteBtn.textContent;
            
            // é˜²æ­¢é‡å¤æ“ä½œ
            if (deleteBtn.disabled) return;
            
            // æ˜¾ç¤ºåˆ é™¤çŠ¶æ€
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'åˆ é™¤ä¸­...';
            deleteBtn.style.opacity = '0.7';
            
            try {
                const response = await fetch(`/auth/users/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showAlert(`ğŸ—‘ï¸ ç”¨æˆ· "${username}" åˆ é™¤æˆåŠŸ`, 'success');
                    
                    // ä¸´æ—¶æ”¹å˜æŒ‰é’®æ ·å¼è¡¨ç¤ºæˆåŠŸ
                    deleteBtn.style.background = '#28a745';
                    deleteBtn.textContent = 'âœ… å·²åˆ é™¤';
                    
                    // 1ç§’ååˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                    setTimeout(() => {
                        loadUsers();
                    }, 1000);
                } else {
                    showAlert('âŒ ' + (data.error || 'åˆ é™¤ç”¨æˆ·å¤±è´¥'), 'error');
                    
                    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                    deleteBtn.style.background = '#dc3545';
                    deleteBtn.textContent = 'âŒ åˆ é™¤å¤±è´¥';
                    
                    // 2ç§’åæ¢å¤æŒ‰é’®
                    setTimeout(() => {
                        deleteBtn.style.background = '';
                        deleteBtn.textContent = originalText;
                        deleteBtn.disabled = false;
                        deleteBtn.style.opacity = '';
                    }, 2000);
                }
            } catch (error) {
                showAlert('ğŸŒ ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
                
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                deleteBtn.style.background = '#dc3545';
                deleteBtn.textContent = 'âŒ ç½‘ç»œé”™è¯¯';
                
                // 2ç§’åæ¢å¤æŒ‰é’®
                setTimeout(() => {
                    deleteBtn.style.background = '';
                    deleteBtn.textContent = originalText;
                    deleteBtn.disabled = false;
                    deleteBtn.style.opacity = '';
                }, 2000);
            }
        }

        // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€ï¼ˆç¦ç”¨/å¯ç”¨ï¼‰
        async function toggleUserStatus(userId, username, currentStatus) {
            const action = currentStatus ? 'ç¦ç”¨' : 'å¯ç”¨';
            if (!confirm(`ç¡®å®šè¦${action}ç”¨æˆ· "${username}" å—ï¼Ÿ`)) return;
            
            // æ‰¾åˆ°å¯¹åº”çš„çŠ¶æ€åˆ‡æ¢æŒ‰é’®
            const toggleBtn = event.target;
            const originalText = toggleBtn.textContent;
            
            // é˜²æ­¢é‡å¤æ“ä½œ
            if (toggleBtn.disabled) return;
            
            // æ˜¾ç¤ºå¤„ç†çŠ¶æ€
            toggleBtn.disabled = true;
            toggleBtn.textContent = 'å¤„ç†ä¸­...';
            toggleBtn.style.opacity = '0.7';
            
            try {
                const response = await fetch(`/auth/users/${userId}/toggle-status`, {
                    method: 'PATCH',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showAlert(`ğŸ”„ ${data.message}`, 'success');
                    
                    // ä¸´æ—¶æ”¹å˜æŒ‰é’®æ ·å¼è¡¨ç¤ºæˆåŠŸ
                    toggleBtn.style.background = '#28a745';
                    toggleBtn.textContent = 'âœ… ' + (currentStatus ? 'å·²ç¦ç”¨' : 'å·²å¯ç”¨');
                    
                    // 1.5ç§’ååˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                    setTimeout(() => {
                        loadUsers();
                    }, 1500);
                } else {
                    showAlert('âŒ ' + (data.error || `${action}ç”¨æˆ·å¤±è´¥`), 'error');
                    
                    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                    toggleBtn.style.background = '#dc3545';
                    toggleBtn.textContent = 'âŒ æ“ä½œå¤±è´¥';
                    
                    // 2ç§’åæ¢å¤æŒ‰é’®
                    setTimeout(() => {
                        toggleBtn.style.background = '';
                        toggleBtn.textContent = originalText;
                        toggleBtn.disabled = false;
                        toggleBtn.style.opacity = '';
                    }, 2000);
                }
            } catch (error) {
                showAlert('ğŸŒ ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
                
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                toggleBtn.style.background = '#dc3545';
                toggleBtn.textContent = 'âŒ ç½‘ç»œé”™è¯¯';
                
                // 2ç§’åæ¢å¤æŒ‰é’®
                setTimeout(() => {
                    toggleBtn.style.background = '';
                    toggleBtn.textContent = originalText;
                    toggleBtn.disabled = false;
                    toggleBtn.style.opacity = '';
                }, 2000);
            }
        }
        
        // ä¿®æ”¹å¯†ç åŠŸèƒ½
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showAlert('âŒ æ–°å¯†ç å’Œç¡®è®¤å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }
            
            // é˜²æ­¢é‡å¤æäº¤
            if (submitBtn.disabled) return;
            
            // æ˜¾ç¤ºä¿®æ”¹çŠ¶æ€
            submitBtn.disabled = true;
            submitBtn.textContent = 'ä¿®æ”¹ä¸­...';
            submitBtn.style.opacity = '0.7';
            
            const formData = new FormData();
            formData.append('currentPassword', currentPassword);
            formData.append('newPassword', newPassword);
            
            try {
                const response = await fetch('/auth/change-password', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showAlert('ğŸ” å¯†ç ä¿®æ”¹æˆåŠŸï¼ä¸‹æ¬¡ç™»å½•è¯·ä½¿ç”¨æ–°å¯†ç ', 'success');
                    
                    // ä¸´æ—¶æ”¹å˜æŒ‰é’®æ ·å¼è¡¨ç¤ºæˆåŠŸ
                    submitBtn.style.background = '#28a745';
                    submitBtn.textContent = 'âœ… ä¿®æ”¹æˆåŠŸ';
                    
                    // é‡ç½®è¡¨å•å¹¶æ¢å¤æŒ‰é’®
                    setTimeout(() => {
                        document.getElementById('changePasswordForm').reset();
                        submitBtn.style.background = '';
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = '';
                    }, 2000);
                } else {
                    showAlert('âŒ ' + (data.error || 'ä¿®æ”¹å¯†ç å¤±è´¥'), 'error');
                    
                    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                    submitBtn.style.background = '#dc3545';
                    submitBtn.textContent = 'âŒ ä¿®æ”¹å¤±è´¥';
                    
                    // 2ç§’åæ¢å¤æŒ‰é’®
                    setTimeout(() => {
                        submitBtn.style.background = '';
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = '';
                    }, 2000);
                }
            } catch (error) {
                showAlert('ğŸŒ ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
                
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                submitBtn.style.background = '#dc3545';
                submitBtn.textContent = 'âŒ ç½‘ç»œé”™è¯¯';
                
                // 2ç§’åæ¢å¤æŒ‰é’®
                setTimeout(() => {
                    submitBtn.style.background = '';
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '';
                }, 2000);
            }
        });
        
        // é‚®ç®±ä¿®æ”¹åŠŸèƒ½
        document.getElementById('changeEmailForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            const newEmail = document.getElementById('newEmail').value;
            const password = document.getElementById('emailPassword').value;
            
            if (!newEmail || !password) {
                showAlert('âŒ è¯·å¡«å†™æ‰€æœ‰å¿…éœ€å­—æ®µ', 'error');
                return;
            }
            
            // éªŒè¯é‚®ç®±æ ¼å¼
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailPattern.test(newEmail)) {
                showAlert('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€', 'error');
                return;
            }
            
            // é˜²æ­¢é‡å¤æäº¤
            if (submitBtn.disabled) return;
            
            // æ˜¾ç¤ºä¿®æ”¹çŠ¶æ€
            submitBtn.disabled = true;
            submitBtn.textContent = 'ä¿®æ”¹ä¸­...';
            submitBtn.style.opacity = '0.7';
            
            try {
                const response = await fetch('/auth/update-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        newEmail: newEmail,
                        currentPassword: password
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showAlert('ğŸ“§ é‚®ç®±ä¿®æ”¹æˆåŠŸï¼æ–°é‚®ç®±ï¼š' + newEmail, 'success');
                    
                    // ä¸´æ—¶æ”¹å˜æŒ‰é’®æ ·å¼è¡¨ç¤ºæˆåŠŸ
                    submitBtn.style.background = '#28a745';
                    submitBtn.textContent = 'âœ… ä¿®æ”¹æˆåŠŸ';
                    
                    // é‡ç½®è¡¨å•å¹¶æ›´æ–°æ˜¾ç¤º
                    setTimeout(() => {
                        document.getElementById('changeEmailForm').reset();
                        document.getElementById('currentEmail').value = newEmail;
                        submitBtn.style.background = '';
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = '';
                    }, 2000);
                } else {
                    showAlert('âŒ ' + (data.error || 'ä¿®æ”¹é‚®ç®±å¤±è´¥'), 'error');
                    
                    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                    submitBtn.style.background = '#dc3545';
                    submitBtn.textContent = 'âŒ ä¿®æ”¹å¤±è´¥';
                    
                    // 2ç§’åæ¢å¤æŒ‰é’®
                    setTimeout(() => {
                        submitBtn.style.background = '';
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = '';
                    }, 2000);
                }
            } catch (error) {
                showAlert('ğŸŒ ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
                
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                submitBtn.style.background = '#dc3545';
                submitBtn.textContent = 'âŒ ç½‘ç»œé”™è¯¯';
                
                // 2ç§’åæ¢å¤æŒ‰é’®
                setTimeout(() => {
                    submitBtn.style.background = '';
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '';
                }, 2000);
            }
        });
        
        // åŠ è½½å½“å‰ç”¨æˆ·é‚®ç®±
        async function loadCurrentUserEmail() {
            try {
                const response = await fetch('/auth/profile', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.user) {
                        document.getElementById('currentEmail').value = data.user.email || 'æœªè®¾ç½®';
                    }
                }
            } catch (error) {
                console.error('Failed to load user email:', error);
                document.getElementById('currentEmail').value = 'åŠ è½½å¤±è´¥';
            }
        }
        
        // è®¿é—®æ§åˆ¶åŠŸèƒ½
        async function loadAccessRules() {
            try {
                const response = await fetch('/auth/access-rules', {
                    credentials: 'include'
                });
                const rules = await response.json();
                
                displayAccessRules(rules);
            } catch (error) {
                console.error('Load access rules error:', error);
                document.getElementById('accessRulesContainer').innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
            }
        }
        
        function displayAccessRules(rules) {
            const container = document.getElementById('accessRulesContainer');
            
            if (rules.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— è®¿é—®æ§åˆ¶è§„åˆ™ï¼Œé»˜è®¤å…è®¸æ‰€æœ‰è®¿é—®</div>';
                return;
            }
            
            const table = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">ç±»å‹</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">å€¼</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">åŠ¨ä½œ</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">æè¿°</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">åˆ›å»ºæ—¶é—´</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rules.map(rule => `
                            <tr style="border-bottom: 1px solid #e1e5e9;">
                                <td style="padding: 12px;">${rule.type === 'ip' ? 'IPåœ°å€' : 'åŸŸå'}</td>
                                <td style="padding: 12px; font-family: monospace;">${rule.value}</td>
                                <td style="padding: 12px;">
                                    <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; ${rule.action === 'allow' ? 'background: #d4edda; color: #155724;' : 'background: #f8d7da; color: #721c24;'}">
                                        ${rule.action === 'allow' ? 'å…è®¸' : 'æ‹’ç»'}
                                    </span>
                                </td>
                                <td style="padding: 12px;">${rule.description || '-'}</td>
                                <td style="padding: 12px;">${new Date(rule.created_at).toLocaleString()}</td>
                                <td style="padding: 12px;">
                                    <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deleteAccessRule(${rule.id})">åˆ é™¤</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }
        
        function showCreateRuleModal() {
            document.getElementById('createRuleModal').style.display = 'block';
        }
        
        function closeCreateRuleModal() {
            document.getElementById('createRuleModal').style.display = 'none';
            document.getElementById('createRuleForm').reset();
        }
        
        document.getElementById('createRuleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('type', document.getElementById('ruleType').value);
            formData.append('value', document.getElementById('ruleValue').value);
            formData.append('action', document.getElementById('ruleAction').value);
            formData.append('description', document.getElementById('ruleDescription').value);
            
            try {
                const response = await fetch('/auth/access-rules', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showAlert('è®¿é—®è§„åˆ™æ·»åŠ æˆåŠŸ', 'success');
                    closeCreateRuleModal();
                    loadAccessRules();
                } else {
                    showAlert(data.error || 'æ·»åŠ è®¿é—®è§„åˆ™å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
            }
        });
        
        async function deleteAccessRule(ruleId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¿é—®è§„åˆ™å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/auth/access-rules/${ruleId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showAlert('è®¿é—®è§„åˆ™åˆ é™¤æˆåŠŸ', 'success');
                    loadAccessRules();
                } else {
                    showAlert(data.error || 'åˆ é™¤è®¿é—®è§„åˆ™å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
            }
        }
        
        async function updateStats() {
            try {
                const response = await fetch('/api/images?paginated=false');
                const result = await response.json();
                
                // å¤„ç†APIå“åº”æ ¼å¼
                const images = result.success ? result.data : (Array.isArray(result) ? result : []);
                
                const total = images.length;
                const landscape = images.filter(img => img.orientation === 'landscape').length;
                const portrait = images.filter(img => img.orientation === 'portrait').length;
                const categories = new Set(images.map(img => img.category)).size;
                
                document.getElementById('totalImages').textContent = total;
                document.getElementById('landscapeImages').textContent = landscape;
                document.getElementById('portraitImages').textContent = portrait;
                document.getElementById('categories').textContent = categories;
            } catch (error) {
                console.error('Failed to update stats:', error);
                // è®¾ç½®é»˜è®¤å€¼
                document.getElementById('totalImages').textContent = '0';
                document.getElementById('landscapeImages').textContent = '0';
                document.getElementById('portraitImages').textContent = '0';
                document.getElementById('categories').textContent = '0';
            }
        }
        
        // ä¼˜åŒ–çš„ç»Ÿè®¡ä¿¡æ¯æ›´æ–° - ä½¿ç”¨ç¼“å­˜å’ŒèŠ‚æµ
        let statsUpdateTimer = null;
        async function updateStatsOptimized() {
            // é˜²æŠ– - é¿å…é¢‘ç¹æ›´æ–°
            if (statsUpdateTimer) {
                clearTimeout(statsUpdateTimer);
            }
            
            statsUpdateTimer = setTimeout(async () => {
                try {
                    // åªè·å–ç»Ÿè®¡æ•°æ®ï¼Œä¸è·å–å®Œæ•´å›¾ç‰‡åˆ—è¡¨
                    const response = await fetch('/api/stats');
                    if (response.ok) {
                        const result = await response.json();
                        
                        if (result.success && result.data) {
                            const stats = result.data;
                            document.getElementById('totalImages').textContent = stats.total || 0;
                            document.getElementById('landscapeImages').textContent = stats.landscape || 0;
                            document.getElementById('portraitImages').textContent = stats.portrait || 0;
                            document.getElementById('categories').textContent = stats.categories || 0;
                        } else {
                            // å›é€€åˆ°åŸæ–¹æ³•
                            updateStats();
                        }
                    } else {
                        // å›é€€åˆ°åŸæ–¹æ³•
                        updateStats();
                    }
                } catch (error) {
                    console.error('Failed to update optimized stats:', error);
                    // å›é€€åˆ°åŸæ–¹æ³•
                    updateStats();
                }
            }, 300); // 300msé˜²æŠ–
        }
        
        // åŠ è½½ç¼©ç•¥å›¾ç»Ÿè®¡ä¿¡æ¯
        async function loadThumbnailStats() {
            try {
                const response = await fetch('/thumbnails/stats', {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const statsEl = document.getElementById('thumbnailStats');
                    
                    if (data.total === 0) {
                        // æ²¡æœ‰æœ¬åœ°å›¾ç‰‡çš„æƒ…å†µ
                        statsEl.innerHTML = `
                            <div style="color: #ff6b6b; font-weight: bold;">
                                ${data.message}
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                ${data.urlImages > 0 ? `å½“å‰ç³»ç»Ÿä¸­æœ‰ ${data.urlImages} å¼ URLå›¾ç‰‡` : ''}
                            </div>
                        `;
                    } else {
                        // æœ‰æœ¬åœ°å›¾ç‰‡çš„æƒ…å†µ
                        statsEl.innerHTML = `
                            <div>
                                æœ¬åœ°å›¾ç‰‡: ${data.total} | 
                                æœ‰ç¼©ç•¥å›¾: ${data.withThumbnails} | 
                                è¦†ç›–ç‡: ${data.coverage}% | 
                                ç¼ºå¤±: ${data.withoutThumbnails}
                            </div>
                            ${data.message ? `<div style="font-size: 12px; color: #666; margin-top: 3px;">${data.message}</div>` : ''}
                        `;
                    }
                } else {
                    showAlert(data.error || 'è·å–ç¼©ç•¥å›¾ç»Ÿè®¡å¤±è´¥', 'error');
                }
            } catch (error) {
                console.warn('æ— æ³•è·å–ç¼©ç•¥å›¾ç»Ÿè®¡:', error);
                document.getElementById('thumbnailStats').textContent = 'ç»Ÿè®¡ä¿¡æ¯è·å–å¤±è´¥';
            }
        }
        
        // ç¼©ç•¥å›¾é”™è¯¯å¤„ç†
        function handleThumbnailError(imgElement, imageId, type) {
            console.warn(`Thumbnail failed to load for image ${imageId} (${type})`);
            
            if (type === 'local') {
                // å¯¹äºæœ¬åœ°å›¾ç‰‡ï¼Œå…ˆå°è¯•åŸå›¾API
                const fallbackUrl = `/api/images/${imageId}`;
                if (imgElement.src !== fallbackUrl) {
                    imgElement.src = fallbackUrl;
                    return;
                }
            }
            
            // æœ€ç»ˆå›é€€åˆ°å ä½ç¬¦
            imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDMwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxjaXJjbGUgY3g9IjE1MCIgY3k9IjEwMCIgcj0iMzAiIGZpbGw9IiNEMUQ1REIiLz4KPHBhdGggZD0iTTEwMCAxNDBMMTQwIDEyMEwxODAgMTUwTDE2MCAyMDBMMTIwIDIwMEwxMDAgMTQwWiIgZmlsbD0iI0QxRDVEQiIvPgo8dGV4dCB4PSIxNTAiIHk9IjI0MCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM2NjY2NjYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPuWbvueJh+WKoOi9veWksei0pTwvdGV4dD4KPHN2Zz4K';
            imgElement.style.opacity = '0.6';
            imgElement.title = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
        }
        
        // æ‰¹é‡ç”Ÿæˆç¼ºå¤±ç¼©ç•¥å›¾
        async function generateMissingThumbnails() {
            try {
                const response = await fetch('/thumbnails/generate-missing', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showAlert(data.message, 'success');
                    // 5ç§’ååˆ·æ–°å›¾ç‰‡åˆ—è¡¨
                    setTimeout(() => {
                        loadImages(currentPage);
                    }, 5000);
                } else {
                    showAlert(data.error || 'ç”Ÿæˆç¼©ç•¥å›¾å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
            }
        }
        
        // ç³»ç»Ÿè®¾ç½®åŠŸèƒ½
        async function loadSystemSettings() {
            try {
                // é¦–å…ˆç¡®ä¿é»˜è®¤é…ç½®å­˜åœ¨
                await ensureDefaultConfigs();
                
                const response = await fetch('/system', {
                    credentials: 'include'
                });
                const configs = await response.json();
                
                // å®šä¹‰é»˜è®¤é…ç½®å€¼
                const defaultConfigs = {
                    'registration_enabled': 'true',
                    'registration_require_approval': 'false',
                    'max_users': '1000',
                    'site_maintenance': 'false',
                    'registration_message': 'æ¬¢è¿æ³¨å†Œ Random Image APIï¼'
                };
                
                // åˆ›å»ºé…ç½®æ˜ å°„
                const configMap = {};
                if (configs && Array.isArray(configs)) {
                    configs.forEach(config => {
                        configMap[config.config_key] = config.config_value;
                    });
                }
                
                // å¡«å……è¡¨å•ï¼Œä½¿ç”¨å®é™…é…ç½®å€¼æˆ–é»˜è®¤å€¼
                Object.keys(defaultConfigs).forEach(key => {
                    const element = document.querySelector(`[name="${key}"]`);
                    if (element) {
                        // ä¼˜å…ˆä½¿ç”¨å®é™…é…ç½®å€¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
                        const value = configMap[key] !== undefined ? configMap[key] : defaultConfigs[key];
                        element.value = value;
                    }
                });
            } catch (error) {
                console.error('Load system settings error:', error);
                showAlert('åŠ è½½ç³»ç»Ÿè®¾ç½®å¤±è´¥', 'error');
                
                // å³ä½¿å‡ºé”™ä¹Ÿè®¾ç½®é»˜è®¤å€¼
                setDefaultSystemSettings();
            }
        }
        
        // ç¡®ä¿é»˜è®¤é…ç½®å­˜åœ¨
        async function ensureDefaultConfigs() {
            try {
                // å…ˆè·å–ç°æœ‰é…ç½®
                const response = await fetch('/system', {
                    credentials: 'include'
                });
                let existingConfigs = [];
                if (response.ok) {
                    const data = await response.json();
                    if (Array.isArray(data)) {
                        existingConfigs = data.map(config => config.config_key);
                    }
                }
                
                const defaultConfigs = [
                    { key: 'registration_enabled', value: 'true', description: 'æ˜¯å¦å…è®¸ç”¨æˆ·æ³¨å†Œ' },
                    { key: 'registration_require_approval', value: 'false', description: 'æ³¨å†Œåæ˜¯å¦éœ€è¦ç®¡ç†å‘˜å®¡æ ¸' },
                    { key: 'max_users', value: '1000', description: 'æœ€å¤§ç”¨æˆ·æ•°é‡é™åˆ¶' },
                    { key: 'site_maintenance', value: 'false', description: 'ç½‘ç«™ç»´æŠ¤æ¨¡å¼' },
                    { key: 'registration_message', value: 'æ¬¢è¿æ³¨å†Œ Random Image APIï¼', description: 'æ³¨å†Œé¡µé¢æ˜¾ç¤ºæ¶ˆæ¯' }
                ];
                
                // ä¸ºæ¯ä¸ªç¼ºå¤±çš„é…ç½®åˆ›å»ºé»˜è®¤å€¼
                for (const config of defaultConfigs) {
                    // åªæœ‰å½“é…ç½®ä¸å­˜åœ¨æ—¶æ‰åˆ›å»º
                    if (!existingConfigs.includes(config.key)) {
                        try {
                            await fetch('/system', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify({
                                    config_key: config.key,
                                    config_value: config.value,
                                    description: config.description
                                })
                            });
                        } catch (error) {
                            // å¦‚æœé…ç½®å·²å­˜åœ¨æˆ–å…¶ä»–é”™è¯¯ï¼Œå¿½ç•¥
                            console.log(`Config ${config.key} already exists or error occurred`);
                        }
                    }
                }
            } catch (error) {
                console.warn('Failed to ensure default configs:', error);
            }
        }
        
        // è®¾ç½®é»˜è®¤ç³»ç»Ÿè®¾ç½®
        function setDefaultSystemSettings() {
            const defaultConfigs = {
                'registration_enabled': 'true',
                'registration_require_approval': 'false',
                'max_users': '1000',
                'site_maintenance': 'false',
                'registration_message': 'æ¬¢è¿æ³¨å†Œ Random Image APIï¼'
            };
            
            Object.keys(defaultConfigs).forEach(key => {
                const element = document.querySelector(`[name="${key}"]`);
                if (element) {
                    element.value = defaultConfigs[key];
                }
            });
        }
        
        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            // é˜²æ­¢é‡å¤æäº¤
            if (submitBtn.disabled) return;
            
            // æ˜¾ç¤ºä¿å­˜çŠ¶æ€
            submitBtn.disabled = true;
            submitBtn.textContent = 'ä¿å­˜ä¸­...';
            submitBtn.style.opacity = '0.7';
            
            const formData = new FormData(e.target);
            const configs = [];
            
            for (const [key, value] of formData.entries()) {
                configs.push({
                    config_key: key,
                    config_value: value,
                    description: getConfigDescription(key)
                });
            }
            
            try {
                const response = await fetch('/system/batch', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ configs }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // æˆåŠŸæç¤º
                    showAlert('ğŸ‰ ç³»ç»Ÿè®¾ç½®ä¿å­˜æˆåŠŸï¼æ³¨å†Œæ§åˆ¶è®¾ç½®å·²æ›´æ–°', 'success');
                    
                    // ä¸´æ—¶æ”¹å˜æŒ‰é’®æ ·å¼è¡¨ç¤ºæˆåŠŸ
                    submitBtn.style.background = '#28a745';
                    submitBtn.textContent = 'âœ… ä¿å­˜æˆåŠŸ';
                    
                    // 2ç§’åæ¢å¤æŒ‰é’®
                    setTimeout(() => {
                        submitBtn.style.background = '';
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = '';
                    }, 2000);
                    
                    // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (data.warnings && data.warnings.length > 0) {
                        setTimeout(() => {
                            showAlert('âš ï¸ æ³¨æ„ï¼š' + data.warnings.join(', '), 'error');
                        }, 1000);
                    }
                    
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (data.errors && data.errors.length > 0) {
                        setTimeout(() => {
                            showAlert('âŒ éƒ¨åˆ†è®¾ç½®ä¿å­˜å¤±è´¥ï¼š' + data.errors.join(', '), 'error');
                        }, 1500);
                    }
                    
                    // åˆ·æ–°ç³»ç»Ÿä¿¡æ¯ä»¥åæ˜ æ–°è®¾ç½®
                    setTimeout(() => {
                        loadSystemInfo();
                        // é‡æ–°åŠ è½½ç³»ç»Ÿè®¾ç½®ä»¥æ˜¾ç¤ºä¿å­˜çš„å€¼
                        loadSystemSettings();
                    }, 500);
                } else {
                    showAlert('âŒ ' + (data.error || 'ä¿å­˜ç³»ç»Ÿè®¾ç½®å¤±è´¥'), 'error');
                    
                    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                    submitBtn.style.background = '#dc3545';
                    submitBtn.textContent = 'âŒ ä¿å­˜å¤±è´¥';
                    
                    // 2ç§’åæ¢å¤æŒ‰é’®
                    setTimeout(() => {
                        submitBtn.style.background = '';
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = '';
                    }, 2000);
                }
            } catch (error) {
                showAlert('ğŸŒ ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
                
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                submitBtn.style.background = '#dc3545';
                submitBtn.textContent = 'âŒ ç½‘ç»œé”™è¯¯';
                
                // 2ç§’åæ¢å¤æŒ‰é’®
                setTimeout(() => {
                    submitBtn.style.background = '';
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '';
                }, 2000);
            }
        });
        
        function getConfigDescription(key) {
            const descriptions = {
                'registration_enabled': 'æ˜¯å¦å…è®¸æ–°ç”¨æˆ·æ³¨å†Œ',
                'registration_require_approval': 'æ–°æ³¨å†Œç”¨æˆ·æ˜¯å¦éœ€è¦ç®¡ç†å‘˜å®¡æ‰¹',
                'max_users': 'ç³»ç»Ÿæœ€å¤§ç”¨æˆ·æ•°é‡é™åˆ¶',
                'site_maintenance': 'ç½‘ç«™ç»´æŠ¤æ¨¡å¼å¼€å…³',
                'registration_message': 'æ³¨å†Œé¡µé¢æ˜¾ç¤ºçš„æ¬¢è¿æ¶ˆæ¯'
            };
            return descriptions[key] || '';
        }
        
        async function loadPendingUsers() {
            try {
                const response = await fetch('/system/pending-users', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                displayPendingUsers(data.pending_users || []);
            } catch (error) {
                console.error('Load pending users error:', error);
                document.getElementById('pendingUsersContainer').innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
            }
        }
        
        function displayPendingUsers(users) {
            const container = document.getElementById('pendingUsersContainer');
            
            if (users.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— å¾…å®¡æ ¸ç”¨æˆ·</div>';
                return;
            }
            
            const table = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">ç”¨æˆ·å</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">é‚®ç®±</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">æ³¨å†Œæ—¶é—´</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr style="border-bottom: 1px solid #e1e5e9;">
                                <td style="padding: 12px;">${user.username}</td>
                                <td style="padding: 12px;">${user.email || '-'}</td>
                                <td style="padding: 12px;">${new Date(user.created_at).toLocaleString()}</td>
                                <td style="padding: 12px;">
                                    <button class="btn" style="padding: 4px 8px; font-size: 12px; margin-right: 5px;" onclick="approveUser(${user.id}, true)">æ‰¹å‡†</button>
                                    <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="approveUser(${user.id}, false)">æ‹’ç»</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }
        
        async function approveUser(userId, approved) {
            const action = approved ? 'æ‰¹å‡†' : 'æ‹’ç»';
            if (!confirm(`ç¡®å®šè¦${action}è¿™ä¸ªç”¨æˆ·å—ï¼Ÿ`)) return;
            
            try {
                const response = await fetch(`/system/approve-user/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ approved }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showAlert(`ç”¨æˆ·${action}æˆåŠŸ`, 'success');
                    loadPendingUsers();
                } else {
                    showAlert(data.error || `${action}ç”¨æˆ·å¤±è´¥`, 'error');
                }
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
            }
        }
        
        async function loadSystemInfo() {
            try {
                const [statsResponse, configResponse] = await Promise.all([
                    fetch('/api/stats'),
                    fetch('/system/public/registration-status')
                ]);
                
                const stats = await statsResponse.json();
                const systemStatus = await configResponse.json();
                
                // å¤„ç†APIå“åº”æ ¼å¼
                const imageCount = stats.success ? stats.data.total : 0;
                const currentUsers = systemStatus.current_users || 0;
                const maxUsers = systemStatus.max_users || 1000;
                const registrationEnabled = systemStatus.registration_enabled || false;
                const maintenanceMode = systemStatus.maintenance_mode || false;
                
                const systemInfo = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #667eea;">${currentUsers}</div>
                            <div>å½“å‰ç”¨æˆ·æ•°</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #667eea;">${maxUsers}</div>
                            <div>æœ€å¤§ç”¨æˆ·æ•°</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em; font-weight: bold; color: ${registrationEnabled ? '#28a745' : '#dc3545'};">
                                ${registrationEnabled ? 'å¼€å¯' : 'å…³é—­'}
                            </div>
                            <div>æ³¨å†ŒçŠ¶æ€</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em; font-weight: bold; color: ${maintenanceMode ? '#ffc107' : '#28a745'};">
                                ${maintenanceMode ? 'ç»´æŠ¤ä¸­' : 'æ­£å¸¸'}
                            </div>
                            <div>ç³»ç»ŸçŠ¶æ€</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('systemInfoContainer').innerHTML = systemInfo;
            } catch (error) {
                console.error('Load system info error:', error);
                document.getElementById('systemInfoContainer').innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
            }
        }
        
        window.onclick = function(event) {
            const modals = ['editModal', 'createUserModal', 'createRuleModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°
        function formatDate(dateString) {
            if (!dateString) return 'æœªçŸ¥æ—¶é—´';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return 'æ—¶é—´æ ¼å¼é”™è¯¯';
            }
        }

        // ===================
        // ğŸ” æœç´¢åŠŸèƒ½ç›¸å…³å‡½æ•°
        // ===================
        
        // è®¾ç½®æœç´¢äº‹ä»¶ç›‘å¬å™¨
        function setupSearchEventListeners() {
            const searchQuery = document.getElementById('searchQuery');
            
            // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡
            performSearch();
            
            // å®æ—¶æœç´¢å»ºè®®
            searchQuery.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length >= 2) {
                    searchTimeout = setTimeout(() => {
                        loadSearchSuggestions(query);
                    }, 300); // 300msé˜²æŠ–
                } else {
                    document.getElementById('searchSuggestions').style.display = 'none';
                }
            });
            
            // å›è½¦æœç´¢
            searchQuery.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('searchSuggestions').style.display = 'none';
                    performSearch();
                }
            });
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­å»ºè®®
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#searchQuery') && !e.target.closest('#searchSuggestions')) {
                    document.getElementById('searchSuggestions').style.display = 'none';
                }
            });
        }
        
        // æ‰§è¡Œæœç´¢
        async function performSearch(page = 1) {
            try {
                const query = document.getElementById('searchQuery').value.trim();
                const category = document.getElementById('searchCategory').value;
                const orientation = document.getElementById('searchOrientation').value;
                const type = document.getElementById('searchType').value;
                const sort = document.getElementById('searchSort').value;
                const limit = document.getElementById('searchLimit').value;
                
                // æ„å»ºæœç´¢å‚æ•°
                const params = new URLSearchParams({
                    page: page,
                    limit: limit,
                    sort: sort
                });
                
                if (query) params.append('query', query);
                if (category) params.append('category', category);
                if (orientation) params.append('orientation', orientation);
                if (type) params.append('type', type);
                
                const response = await fetch(`/api/search?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    searchCurrentPage = page;
                    searchTotalPages = result.pagination.totalPages;
                    searchCurrentQuery = query;
                    
                    displaySearchResults(result.data, result.pagination, result.meta);
                    updateSearchPagination(result.pagination);
                } else {
                    showAlert(result.message || 'æœç´¢å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('Search error:', error);
                showAlert('æœç´¢æ—¶å‘ç”Ÿé”™è¯¯', 'error');
            }
        }
        
        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(images, pagination, meta) {
            const resultsContainer = document.getElementById('searchResults');
            const statsContainer = document.getElementById('searchStats');
            const countElement = document.getElementById('searchResultCount');
            
            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            statsContainer.style.display = 'block';
            countElement.textContent = `æ‰¾åˆ° ${pagination.total} å¼ å›¾ç‰‡ (ç¬¬ ${pagination.page}/${pagination.totalPages} é¡µ)`;
            
            // è°ƒè¯•ä¿¡æ¯
            console.log('æœç´¢ç»“æœ:', { images, pagination, meta });
            
            if (images.length === 0) {
                resultsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ”</div>
                        <h3>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å›¾ç‰‡</h3>
                        <p>å°è¯•ä½¿ç”¨ä¸åŒçš„å…³é”®è¯æˆ–ç­›é€‰æ¡ä»¶</p>
                        <p style="margin-top: 10px; font-size: 14px; color: #999;">
                            æç¤º: å¦‚æœæ˜¯é¦–æ¬¡ä½¿ç”¨ï¼Œè¯·å…ˆåœ¨"ä¸Šä¼ å›¾ç‰‡"æˆ–"ç®¡ç†å›¾ç‰‡"é¡µé¢æ·»åŠ ä¸€äº›å›¾ç‰‡
                        </p>
                    </div>
                `;
                return;
            }
            
            // ç”Ÿæˆæœç´¢ç»“æœHTML
            let html = '<div class="image-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">';
            
            images.forEach((image, index) => {
                console.log(`å¤„ç†å›¾ç‰‡ ${index + 1}:`, image);
                
                const imageUrl = image.is_local ? `/api/images/${image.id}` : image.url;
                const thumbnailUrl = image.thumbnail_url || imageUrl;
                const typeLabel = image.is_local ? 'æœ¬åœ°' : 'é“¾æ¥';
                const typeClass = image.is_local ? 'local' : 'url';
                
                html += `
                    <div class="image-item" style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: transform 0.3s; cursor: pointer; position: relative;"
                         onmouseover="this.style.transform='translateY(-5px)'" 
                         onmouseout="this.style.transform='translateY(0)'">
                        <!-- é€‰æ‹©æ¡† -->
                        <div style="position: absolute; top: 8px; left: 8px; z-index: 100;">
                            <input type="checkbox" class="image-checkbox" data-image-id="${image.id}" 
                                   onchange="updateBatchSelection()" 
                                   style="transform: scale(1.3); accent-color: #667eea;">
                        </div>
                        
                        <div style="position: relative;">
                            <img src="${thumbnailUrl}" alt="${image.original_name || 'å›¾ç‰‡'}" 
                                 style="width: 100%; height: 150px; object-fit: cover; cursor: pointer;"
                                 onclick="window.open('${imageUrl}', '_blank')"
                                 onerror="this.src='${imageUrl}'; console.error('ç¼©ç•¥å›¾åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸå›¾:', '${thumbnailUrl}');"
                                 onload="console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ:', '${thumbnailUrl}');">
                            <div style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                                ${typeLabel}
                            </div>
                            <div style="position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px;">
                                ID: ${image.id}
                            </div>
                        </div>
                        <div style="padding: 15px;">
                            <div style="font-weight: bold; margin-bottom: 8px; color: #333; word-break: break-all;">${image.original_name || image.filename || 'æœªçŸ¥æ–‡ä»¶'}</div>
                            <div style="color: #666; font-size: 14px; margin-bottom: 4px;">åˆ†ç±»: ${image.category || 'æœªåˆ†ç±»'}</div>
                            <div style="color: #666; font-size: 14px; margin-bottom: 8px;">æ–¹å‘: ${image.orientation === 'landscape' ? 'æ¨ªå‘' : 'çºµå‘'}</div>
                            <div style="color: #999; font-size: 12px;">${formatDate(image.created_at)}</div>
                            <div style="margin-top: 8px; display: flex; gap: 5px; flex-wrap: wrap;">
                                <button onclick="copyImageUrl('${imageUrl}')" style="padding: 4px 8px; font-size: 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">å¤åˆ¶é“¾æ¥</button>
                                <button onclick="previewImage('${imageUrl}', '${image.original_name || image.filename}')" style="padding: 4px 8px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">é¢„è§ˆ</button>
                                <button onclick="editImage(${image.id}, '${image.original_name || image.filename}')" style="padding: 4px 8px; font-size: 12px; background: #ffc107; color: #212529; border: none; border-radius: 4px; cursor: pointer;">ç¼–è¾‘</button>
                                <button onclick="deleteImageFromSearch(${image.id}, '${image.original_name || image.filename}')" style="padding: 4px 8px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            resultsContainer.innerHTML = html;
        }
        
        // æ›´æ–°æœç´¢åˆ†é¡µ
        function updateSearchPagination(pagination) {
            const paginationContainer = document.getElementById('searchPagination');
            
            if (pagination.totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            let html = '<div class="pagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin: 20px 0;">';
            
            // ä¸Šä¸€é¡µ
            if (pagination.hasPrev) {
                html += `<button onclick="performSearch(${pagination.page - 1})" style="padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">ä¸Šä¸€é¡µ</button>`;
            }
            
            // é¡µç æŒ‰é’®
            const startPage = Math.max(1, pagination.page - 2);
            const endPage = Math.min(pagination.totalPages, pagination.page + 2);
            
            if (startPage > 1) {
                html += `<button onclick="performSearch(1)" style="padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">1</button>`;
                if (startPage > 2) {
                    html += '<span style="padding: 8px;">...</span>';
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === pagination.page;
                const buttonStyle = isActive ? 
                    'padding: 8px 12px; border: 1px solid #667eea; background: #667eea; color: white; border-radius: 4px; cursor: pointer;' :
                    'padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;';
                
                html += `<button onclick="performSearch(${i})" style="${buttonStyle}">${i}</button>`;
            }
            
            if (endPage < pagination.totalPages) {
                if (endPage < pagination.totalPages - 1) {
                    html += '<span style="padding: 8px;">...</span>';
                }
                html += `<button onclick="performSearch(${pagination.totalPages})" style="padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">${pagination.totalPages}</button>`;
            }
            
            // ä¸‹ä¸€é¡µ
            if (pagination.hasNext) {
                html += `<button onclick="performSearch(${pagination.page + 1})" style="padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">ä¸‹ä¸€é¡µ</button>`;
            }
            
            html += '</div>';
            paginationContainer.innerHTML = html;
        }
        
        // åŠ è½½æœç´¢å»ºè®®
        async function loadSearchSuggestions(query) {
            try {
                const response = await fetch(`/api/search/suggestions?q=${encodeURIComponent(query)}&limit=5`);
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const suggestionsContainer = document.getElementById('searchSuggestions');
                    
                    let html = '';
                    result.data.forEach(suggestion => {
                        const icon = suggestion.type === 'category' ? 'ğŸ·ï¸' : 'ğŸ“';
                        html += `
                            <div onclick="selectSuggestion('${suggestion.text}')" 
                                 style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 8px;"
                                 onmouseover="this.style.background='#f5f5f5'" 
                                 onmouseout="this.style.background='white'">
                                <span>${icon}</span>
                                <span>${suggestion.text}</span>
                                <small style="margin-left: auto; color: #999;">${suggestion.type === 'category' ? 'åˆ†ç±»' : 'æ–‡ä»¶å'}</small>
                            </div>
                        `;
                    });
                    
                    suggestionsContainer.innerHTML = html;
                    suggestionsContainer.style.display = 'block';
                } else {
                    document.getElementById('searchSuggestions').style.display = 'none';
                }
            } catch (error) {
                console.error('Load suggestions error:', error);
            }
        }
        
        // é€‰æ‹©æœç´¢å»ºè®®
        function selectSuggestion(text) {
            document.getElementById('searchQuery').value = text;
            document.getElementById('searchSuggestions').style.display = 'none';
            performSearch();
        }
        
        
        // æ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡
        function showAllImages() {
            // æ¸…ç©ºæ‰€æœ‰æœç´¢æ¡ä»¶
            document.getElementById('searchQuery').value = '';
            document.getElementById('searchCategory').value = '';
            document.getElementById('searchOrientation').value = '';
            document.getElementById('searchType').value = '';
            document.getElementById('searchSort').value = 'newest';
            document.getElementById('searchLimit').value = '12';
            
            // æ‰§è¡Œç©ºæœç´¢ï¼Œæ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡
            performSearch();
        }

        // å¤åˆ¶å›¾ç‰‡é“¾æ¥
        function copyImageUrl(url) {
            navigator.clipboard.writeText(window.location.origin + url).then(() => {
                showAlert('å›¾ç‰‡é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                // å¤‡ç”¨æ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = window.location.origin + url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showAlert('å›¾ç‰‡é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            });
        }

        // é¢„è§ˆå›¾ç‰‡
        function previewImage(url, title) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; cursor: pointer;
            `;
            
            modal.innerHTML = `
                <div style="position: relative; max-width: 90%; max-height: 90%; text-align: center;">
                    <img src="${url}" alt="${title}" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px;">
                    <div style="position: absolute; top: -40px; left: 0; right: 0; color: white; font-size: 16px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">
                        ${title}
                    </div>
                    <div style="position: absolute; top: -40px; right: 0; color: white; font-size: 24px; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); border-radius: 50%;">
                        Ã—
                    </div>
                </div>
            `;
            
            modal.onclick = () => document.body.removeChild(modal);
            document.body.appendChild(modal);
        }

        // ä»æœç´¢ç»“æœåˆ é™¤å›¾ç‰‡
        async function deleteImageFromSearch(imageId, imageName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å›¾ç‰‡ "${imageName}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }

            try {
                const response = await fetch(`/api/images/${imageId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert(`å›¾ç‰‡ "${imageName}" åˆ é™¤æˆåŠŸ`, 'success');
                    // é‡æ–°æ‰§è¡Œæœç´¢ä»¥åˆ·æ–°ç»“æœ
                    performSearch(searchCurrentPage);
                } else {
                    showAlert(`åˆ é™¤å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤å›¾ç‰‡é”™è¯¯:', error);
                showAlert('åˆ é™¤å›¾ç‰‡æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // ç¼–è¾‘å›¾ç‰‡ä¿¡æ¯
        function editImage(imageId, imageName) {
            // åˆ›å»ºç¼–è¾‘æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 10000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; max-height: 90%; overflow-y: auto;">
                    <h3 style="margin-top: 0; color: #333;">ç¼–è¾‘å›¾ç‰‡ä¿¡æ¯</h3>
                    <p style="color: #666; margin-bottom: 20px;">å›¾ç‰‡: ${imageName}</p>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">åˆ†ç±»:</label>
                        <select id="editCategory" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="landscape">é£æ™¯</option>
                            <option value="anime">åŠ¨æ¼«</option>
                            <option value="beauty">ç¾å¥³</option>
                            <option value="nature">è‡ªç„¶</option>
                            <option value="city">åŸå¸‚</option>
                            <option value="art">è‰ºæœ¯</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ–¹å‘:</label>
                        <select id="editOrientation" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="landscape">æ¨ªå‘</option>
                            <option value="portrait">çºµå‘</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ–°URL (ä»…é™URLç±»å‹å›¾ç‰‡):</label>
                        <input type="url" id="editUrl" placeholder="https://example.com/image.jpg" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <small style="color: #999;">ç•™ç©ºåˆ™ä¸ä¿®æ”¹URL</small>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeEditModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                        <button onclick="saveImageEdit(${imageId})" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">ä¿å­˜</button>
                    </div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            document.body.appendChild(modal);
            
            // åŠ è½½å½“å‰å›¾ç‰‡ä¿¡æ¯
            loadImageForEdit(imageId);
        }

        // åŠ è½½å›¾ç‰‡ä¿¡æ¯è¿›è¡Œç¼–è¾‘
        async function loadImageForEdit(imageId) {
            try {
                // ä»å½“å‰æœç´¢ç»“æœä¸­æ‰¾åˆ°å›¾ç‰‡ä¿¡æ¯
                const images = document.querySelectorAll('.image-item');
                // è¿™é‡Œå¯ä»¥é€šè¿‡APIè·å–è¯¦ç»†ä¿¡æ¯ï¼Œä½†ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€äº›é»˜è®¤å€¼
                // å®é™…åº”ç”¨ä¸­åº”è¯¥è°ƒç”¨ GET /api/images/{id} è·å–è¯¦ç»†ä¿¡æ¯
            } catch (error) {
                console.error('åŠ è½½å›¾ç‰‡ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            const modals = document.querySelectorAll('[style*="position: fixed"]');
            modals.forEach(modal => {
                if (modal.innerHTML.includes('ç¼–è¾‘å›¾ç‰‡ä¿¡æ¯')) {
                    document.body.removeChild(modal);
                }
            });
        }

        // ä¿å­˜å›¾ç‰‡ç¼–è¾‘
        async function saveImageEdit(imageId) {
            try {
                const category = document.getElementById('editCategory').value;
                const orientation = document.getElementById('editOrientation').value;
                const url = document.getElementById('editUrl').value.trim();

                const formData = new FormData();
                formData.append('category', category);
                formData.append('orientation', orientation);
                if (url) {
                    formData.append('url', url);
                }

                const response = await fetch(`/api/images/${imageId}`, {
                    method: 'PUT',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('å›¾ç‰‡ä¿¡æ¯æ›´æ–°æˆåŠŸ', 'success');
                    closeEditModal();
                    // é‡æ–°æ‰§è¡Œæœç´¢ä»¥åˆ·æ–°ç»“æœ
                    performSearch(searchCurrentPage);
                } else {
                    showAlert(`æ›´æ–°å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜å›¾ç‰‡ç¼–è¾‘é”™è¯¯:', error);
                showAlert('ä¿å­˜å›¾ç‰‡ä¿¡æ¯æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // æ‰¹é‡åˆ é™¤åŠŸèƒ½
        function showBatchDeleteOptions() {
            const selectedImages = document.querySelectorAll('.image-item input[type="checkbox"]:checked');
            if (selectedImages.length === 0) {
                showAlert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å›¾ç‰‡', 'error');
                return;
            }

            if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedImages.length} å¼ å›¾ç‰‡å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                batchDeleteImages(selectedImages);
            }
        }

        // æ‰§è¡Œæ‰¹é‡åˆ é™¤
        async function batchDeleteImages(selectedImages) {
            const deletePromises = [];
            const imageIds = [];

            selectedImages.forEach(checkbox => {
                const imageId = checkbox.dataset.imageId;
                if (imageId) {
                    imageIds.push(imageId);
                    deletePromises.push(
                        fetch(`/api/images/${imageId}`, { method: 'DELETE' })
                    );
                }
            });

            try {
                const results = await Promise.all(deletePromises);
                let successCount = 0;
                let failCount = 0;

                results.forEach(response => {
                    if (response.ok) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                });

                if (failCount === 0) {
                    showAlert(`æˆåŠŸåˆ é™¤ ${successCount} å¼ å›¾ç‰‡`, 'success');
                } else {
                    showAlert(`åˆ é™¤å®Œæˆ: æˆåŠŸ ${successCount} å¼ ï¼Œå¤±è´¥ ${failCount} å¼ `, 'error');
                }

                // é‡æ–°æ‰§è¡Œæœç´¢ä»¥åˆ·æ–°ç»“æœ
                performSearch(searchCurrentPage);
            } catch (error) {
                console.error('æ‰¹é‡åˆ é™¤é”™è¯¯:', error);
                showAlert('æ‰¹é‡åˆ é™¤æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllImages');
            const imageCheckboxes = document.querySelectorAll('.image-checkbox');
            
            imageCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateBatchSelection();
        }

        // æ›´æ–°æ‰¹é‡é€‰æ‹©çŠ¶æ€
        function updateBatchSelection() {
            const selectedCheckboxes = document.querySelectorAll('.image-checkbox:checked');
            const totalCheckboxes = document.querySelectorAll('.image-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllImages');
            const selectedCount = document.getElementById('selectedCount');
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            const batchEditBtn = document.getElementById('batchEditBtn');
            
            // æ›´æ–°å…¨é€‰çŠ¶æ€
            if (selectedCheckboxes.length === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (selectedCheckboxes.length === totalCheckboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
                selectAllCheckbox.checked = false;
            }
            
            // æ›´æ–°é€‰æ‹©è®¡æ•°
            selectedCount.textContent = `å·²é€‰æ‹© ${selectedCheckboxes.length} å¼ å›¾ç‰‡`;
            
            // æ›´æ–°æ‰¹é‡æ“ä½œæŒ‰é’®çŠ¶æ€
            const hasSelection = selectedCheckboxes.length > 0;
            batchDeleteBtn.disabled = !hasSelection;
            batchEditBtn.disabled = !hasSelection;
            
            if (hasSelection) {
                batchDeleteBtn.style.opacity = '1';
                batchEditBtn.style.opacity = '1';
                batchDeleteBtn.style.cursor = 'pointer';
                batchEditBtn.style.cursor = 'pointer';
            } else {
                batchDeleteBtn.style.opacity = '0.5';
                batchEditBtn.style.opacity = '0.5';
                batchDeleteBtn.style.cursor = 'not-allowed';
                batchEditBtn.style.cursor = 'not-allowed';
            }
        }

        // æ‰¹é‡ç¼–è¾‘åŠŸèƒ½
        function showBatchEditOptions() {
            const selectedCheckboxes = document.querySelectorAll('.image-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showAlert('è¯·å…ˆé€‰æ‹©è¦ç¼–è¾‘çš„å›¾ç‰‡', 'error');
                return;
            }

            // åˆ›å»ºæ‰¹é‡ç¼–è¾‘æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 10000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; max-height: 90%; overflow-y: auto;">
                    <h3 style="margin-top: 0; color: #333;">æ‰¹é‡ç¼–è¾‘å›¾ç‰‡ä¿¡æ¯</h3>
                    <p style="color: #666; margin-bottom: 20px;">å·²é€‰æ‹© ${selectedCheckboxes.length} å¼ å›¾ç‰‡</p>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                            <input type="checkbox" id="batchEditCategory" onchange="toggleBatchEditField('Category')"> æ‰¹é‡ä¿®æ”¹åˆ†ç±»
                        </label>
                        <select id="batchCategory" disabled style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="landscape">é£æ™¯</option>
                            <option value="anime">åŠ¨æ¼«</option>
                            <option value="beauty">ç¾å¥³</option>
                            <option value="nature">è‡ªç„¶</option>
                            <option value="city">åŸå¸‚</option>
                            <option value="art">è‰ºæœ¯</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                            <input type="checkbox" id="batchEditOrientation" onchange="toggleBatchEditField('Orientation')"> æ‰¹é‡ä¿®æ”¹æ–¹å‘
                        </label>
                        <select id="batchOrientation" disabled style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="landscape">æ¨ªå‘</option>
                            <option value="portrait">çºµå‘</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeBatchEditModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                        <button onclick="saveBatchEdit()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">ä¿å­˜ä¿®æ”¹</button>
                    </div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            document.body.appendChild(modal);
        }

        // åˆ‡æ¢æ‰¹é‡ç¼–è¾‘å­—æ®µ
        function toggleBatchEditField(fieldName) {
            const checkbox = document.getElementById(`batchEdit${fieldName}`);
            const field = document.getElementById(`batch${fieldName}`);
            field.disabled = !checkbox.checked;
            if (checkbox.checked) {
                field.style.opacity = '1';
                field.style.cursor = 'pointer';
            } else {
                field.style.opacity = '0.5';
                field.style.cursor = 'not-allowed';
            }
        }

        // å…³é—­æ‰¹é‡ç¼–è¾‘æ¨¡æ€æ¡†
        function closeBatchEditModal() {
            const modals = document.querySelectorAll('[style*="position: fixed"]');
            modals.forEach(modal => {
                if (modal.innerHTML.includes('æ‰¹é‡ç¼–è¾‘å›¾ç‰‡ä¿¡æ¯')) {
                    document.body.removeChild(modal);
                }
            });
        }

        // ä¿å­˜æ‰¹é‡ç¼–è¾‘
        async function saveBatchEdit() {
            try {
                const selectedCheckboxes = document.querySelectorAll('.image-checkbox:checked');
                const editCategory = document.getElementById('batchEditCategory').checked;
                const editOrientation = document.getElementById('batchEditOrientation').checked;
                
                if (!editCategory && !editOrientation) {
                    showAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦ä¿®æ”¹çš„å­—æ®µ', 'error');
                    return;
                }
                
                const updates = [];
                selectedCheckboxes.forEach(checkbox => {
                    const imageId = checkbox.dataset.imageId;
                    if (imageId) {
                        const formData = new FormData();
                        
                        if (editCategory) {
                            formData.append('category', document.getElementById('batchCategory').value);
                        }
                        if (editOrientation) {
                            formData.append('orientation', document.getElementById('batchOrientation').value);
                        }
                        
                        updates.push(
                            fetch(`/api/images/${imageId}`, {
                                method: 'PUT',
                                body: formData
                            })
                        );
                    }
                });

                const results = await Promise.all(updates);
                let successCount = 0;
                let failCount = 0;

                results.forEach(response => {
                    if (response.ok) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                });

                if (failCount === 0) {
                    showAlert(`æˆåŠŸæ›´æ–° ${successCount} å¼ å›¾ç‰‡`, 'success');
                } else {
                    showAlert(`æ›´æ–°å®Œæˆ: æˆåŠŸ ${successCount} å¼ ï¼Œå¤±è´¥ ${failCount} å¼ `, 'error');
                }

                closeBatchEditModal();
                // é‡æ–°æ‰§è¡Œæœç´¢ä»¥åˆ·æ–°ç»“æœ
                performSearch(searchCurrentPage);
            } catch (error) {
                console.error('æ‰¹é‡ç¼–è¾‘é”™è¯¯:', error);
                showAlert('æ‰¹é‡ç¼–è¾‘æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // å¼ºåˆ¶æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        async function forceUpdateStats() {
            console.log('ğŸ”„ å¼ºåˆ¶åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯...');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('totalImages').textContent = '...';
            document.getElementById('landscapeImages').textContent = '...';
            document.getElementById('portraitImages').textContent = '...';
            document.getElementById('categories').textContent = '...';
            
            try {
                // ä¼˜å…ˆä½¿ç”¨stats API
                const response = await fetch('/api/stats?_t=' + Date.now()); // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
                const result = await response.json();
                
                if (result.success && result.data) {
                    const stats = result.data;
                    document.getElementById('totalImages').textContent = stats.total || 0;
                    document.getElementById('landscapeImages').textContent = stats.landscape || 0;
                    document.getElementById('portraitImages').textContent = stats.portrait || 0;
                    document.getElementById('categories').textContent = stats.categories || 0;
                    
                    console.log('âœ… ç»Ÿè®¡ä¿¡æ¯åˆ·æ–°æˆåŠŸ:', stats);
                    showAlert('ç»Ÿè®¡ä¿¡æ¯å·²åˆ·æ–°', 'success');
                } else {
                    throw new Error('Stats API å“åº”æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                console.error('âŒ Stats API å¤±è´¥ï¼Œå›é€€åˆ°å›¾ç‰‡åˆ—è¡¨API:', error);
                
                try {
                    // å›é€€åˆ°å®Œæ•´å›¾ç‰‡åˆ—è¡¨API
                    const response = await fetch('/api/images?paginated=false&_t=' + Date.now());
                    const result = await response.json();
                    
                    const images = result.success ? result.data : (Array.isArray(result) ? result : []);
                    
                    const total = images.length;
                    const landscape = images.filter(img => img.orientation === 'landscape').length;
                    const portrait = images.filter(img => img.orientation === 'portrait').length;
                    const categories = new Set(images.map(img => img.category)).size;
                    
                    document.getElementById('totalImages').textContent = total;
                    document.getElementById('landscapeImages').textContent = landscape;
                    document.getElementById('portraitImages').textContent = portrait;
                    document.getElementById('categories').textContent = categories;
                    
                    console.log('âœ… ç»Ÿè®¡ä¿¡æ¯åˆ·æ–°æˆåŠŸ (å›é€€æ–¹æ³•):', {total, landscape, portrait, categories});
                    showAlert('ç»Ÿè®¡ä¿¡æ¯å·²åˆ·æ–°', 'success');
                } catch (fallbackError) {
                    console.error('âŒ æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥:', fallbackError);
                    
                    // è®¾ç½®é”™è¯¯çŠ¶æ€
                    document.getElementById('totalImages').textContent = 'é”™è¯¯';
                    document.getElementById('landscapeImages').textContent = 'é”™è¯¯';
                    document.getElementById('portraitImages').textContent = 'é”™è¯¯';
                    document.getElementById('categories').textContent = 'é”™è¯¯';
                    
                    showAlert('åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯å¤±è´¥', 'error');
                }
            }
        }

        // IPç®¡ç†ç›¸å…³å‡½æ•°
        async function refreshBlockedIPs() {
            try {
                const response = await fetch('/admin/blocked-ips');
                const result = await response.json();
                
                if (result.success) {
                    const blockedIPs = result.data;
                    const count = blockedIPs.blocked.length + blockedIPs.suspicious.length;
                    
                    document.getElementById('blockedIPCount').textContent = count;
                    
                    let html = '';
                    if (count === 0) {
                        html = '<div style="text-align: center; color: #28a745; padding: 20px;">âœ… å½“å‰æ²¡æœ‰è¢«é™åˆ¶çš„IPåœ°å€</div>';
                    } else {
                        html = '<div style="margin-bottom: 15px;">';
                        
                        if (blockedIPs.blocked.length > 0) {
                            html += `<h5 style="color: #dc3545;">ğŸš« è¢«å°ç¦çš„IP (${blockedIPs.blocked.length}):</h5>`;
                            html += '<div style="background: #f8d7da; padding: 10px; border-radius: 5px; margin-bottom: 10px;">';
                            blockedIPs.blocked.forEach(ip => {
                                html += `<div style="display: flex; justify-content: space-between; align-items: center; margin: 5px 0;">
                                    <span><code>${ip}</code></span>
                                    <button class="btn btn-sm btn-danger" onclick="unblockIP('${ip}')">è§£é™¤</button>
                                </div>`;
                            });
                            html += '</div>';
                        }
                        
                        if (blockedIPs.suspicious.length > 0) {
                            html += `<h5 style="color: #ffc107;">âš ï¸ å¯ç–‘IP (${blockedIPs.suspicious.length}):</h5>`;
                            html += '<div style="background: #fff3cd; padding: 10px; border-radius: 5px;">';
                            blockedIPs.suspicious.forEach(ip => {
                                html += `<div style="display: flex; justify-content: space-between; align-items: center; margin: 5px 0;">
                                    <span><code>${ip}</code></span>
                                    <button class="btn btn-sm btn-warning" onclick="unblockIP('${ip}')">æ¸…é™¤</button>
                                </div>`;
                            });
                            html += '</div>';
                        }
                        
                        html += '</div>';
                    }
                    
                    document.getElementById('blockedIPsList').innerHTML = html;
                } else {
                    throw new Error(result.message || 'è·å–IPé™åˆ¶åˆ—è¡¨å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ·æ–°IPåˆ—è¡¨é”™è¯¯:', error);
                document.getElementById('blockedIPsList').innerHTML = 
                    '<div style="color: #dc3545; text-align: center; padding: 20px;">âŒ è·å–IPé™åˆ¶åˆ—è¡¨å¤±è´¥</div>';
            }
        }

        async function clearAllIPRestrictions() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰IPé™åˆ¶å—ï¼Ÿè¿™å°†è§£é™¤æ‰€æœ‰è¢«é™åˆ¶çš„IPåœ°å€çš„è®¿é—®é™åˆ¶ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch('/admin/clear-ip-restrictions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`æˆåŠŸæ¸…é™¤æ‰€æœ‰IPé™åˆ¶ï¼è§£é™¤äº† ${result.data.clearedBlocked} ä¸ªè¢«å°ç¦IPï¼Œ${result.data.clearedSuspicious || 0} ä¸ªå¯ç–‘IP`, 'success');
                    refreshBlockedIPs(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    throw new Error(result.message || 'æ¸…é™¤IPé™åˆ¶å¤±è´¥');
                }
            } catch (error) {
                console.error('æ¸…é™¤IPé™åˆ¶é”™è¯¯:', error);
                showAlert('æ¸…é™¤IPé™åˆ¶å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function unblockIP(ip) {
            if (!confirm(`ç¡®å®šè¦è§£é™¤IPåœ°å€ ${ip} çš„è®¿é—®é™åˆ¶å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/blocked-ips/${encodeURIComponent(ip)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`æˆåŠŸè§£é™¤IP ${ip} çš„è®¿é—®é™åˆ¶`, 'success');
                    refreshBlockedIPs(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    throw new Error(result.message || 'è§£é™¤IPé™åˆ¶å¤±è´¥');
                }
            } catch (error) {
                console.error('è§£é™¤IPé™åˆ¶é”™è¯¯:', error);
                showAlert('è§£é™¤IPé™åˆ¶å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function emergencyClearIP() {
            if (!confirm('è¿™æ˜¯ç´§æ€¥æ“ä½œï¼ç¡®å®šè¦ç«‹å³æ¸…é™¤æ‰€æœ‰IPé™åˆ¶å—ï¼Ÿ\n\nè¿™å°†ï¼š\n- æ¸…é™¤æ‰€æœ‰è¢«å°ç¦çš„IP\n- æ¸…é™¤æ‰€æœ‰å¯ç–‘IPè®°å½•\n- é‡ç½®æ‰€æœ‰å®‰å…¨è®¡æ•°å™¨')) {
                return;
            }
            
            try {
                const response = await fetch('/admin/emergency-clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ emergencyKey: 'emergency-clear-2024' })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('ğŸš¨ ç´§æ€¥æ¸…é™¤å®Œæˆï¼æ‰€æœ‰IPé™åˆ¶å·²è§£é™¤', 'success');
                    refreshBlockedIPs(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    throw new Error(result.message || 'ç´§æ€¥æ¸…é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('ç´§æ€¥æ¸…é™¤é”™è¯¯:', error);
                showAlert('ç´§æ€¥æ¸…é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åœ¨å®‰å…¨è®¾ç½®æ ‡ç­¾æ¿€æ´»æ—¶åŠ è½½IPä¿¡æ¯
        function showTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®
            event.target.classList.add('active');
            
            // æ ¹æ®ä¸åŒæ ‡ç­¾åŠ è½½å¯¹åº”å†…å®¹
            if (tabName === 'manage') {
                loadImages();
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'security') {
                loadAccessRules();
                refreshBlockedIPs(); // åŠ è½½IPé™åˆ¶ä¿¡æ¯
                loadCurrentUserEmail(); // åŠ è½½å½“å‰ç”¨æˆ·é‚®ç®±
            } else if (tabName === 'system') {
                loadSystemInfo();
            }
        }

    </script>
</body>
</html>