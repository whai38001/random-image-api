<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>随机图片API - 后台管理</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .image-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .image-card:hover {
            transform: translateY(-5px);
        }
        
        .image-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .image-card-content {
            padding: 15px;
        }
        
        .image-card-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .image-card-meta {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .image-card-actions {
            display: flex;
            gap: 10px;
        }
        
        .thumbnail-container {
            position: relative;
            width: 100%;
            height: 200px;
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .thumbnail:hover {
            transform: scale(1.05);
        }
        
        .thumbnail-overlay {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .image-id {
            font-weight: bold;
        }
        
        .batch-toolbar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        
        .batch-actions {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .selected-count {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .image-checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 20px;
            height: 20px;
            z-index: 10;
        }
        
        .image-card.selected {
            border: 3px solid #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .thumbnail-container {
            position: relative;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        
        .close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        
        .close:hover {
            color: #000;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            display: none;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #666;
        }
        
        .api-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .api-info h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .api-endpoint {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin-bottom: 10px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            gap: 10px;
        }
        
        .page-numbers {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .page-number {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .page-number:hover {
            background: #f8f9fa;
        }
        
        .page-number.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .page-number.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .pagination-info {
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .images-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .pagination {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .page-numbers {
                flex-wrap: wrap;
                gap: 3px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>随机图片API管理系统</h1>
                    <p>管理你的图片库，支持风景、动漫、美女等分类，PC和移动端适配</p>
                </div>
                <div style="text-align: right; color: rgba(255,255,255,0.9);">
                    <div id="userInfo" style="margin-bottom: 10px; font-size: 14px;"></div>
                    <button onclick="logout()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: all 0.3s;">
                        登出
                    </button>
                </div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalImages">0</div>
                <div>总图片数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="landscapeImages">0</div>
                <div>横屏图片</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="portraitImages">0</div>
                <div>竖屏图片</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="categories">0</div>
                <div>分类数量</div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('upload')">上传图片</button>
            <button class="tab" onclick="showTab('manage')">管理图片</button>
            <button class="tab" onclick="showTab('users')">账号管理</button>
            <button class="tab" onclick="showTab('security')">安全设置</button>
        </div>
        
        <div id="uploadTab" class="tab-content active">
            <div class="alert alert-success" id="successAlert"></div>
            <div class="alert alert-error" id="errorAlert"></div>
            
            <h2>添加新图片</h2>
            <form id="uploadForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="category">分类</label>
                        <select id="category" name="category" required>
                            <option value="">选择分类</option>
                            <option value="landscape">风景</option>
                            <option value="anime">动漫</option>
                            <option value="beauty">美女</option>
                            <option value="nature">自然</option>
                            <option value="city">城市</option>
                            <option value="art">艺术</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="orientation">方向</label>
                        <select id="orientation" name="orientation" required>
                            <option value="">选择方向</option>
                            <option value="landscape">横屏 (PC)</option>
                            <option value="portrait">竖屏 (Mobile)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="imageFile">本地图片上传</label>
                    <input type="file" id="imageFile" name="image" accept="image/*">
                </div>
                
                <div style="text-align: center; margin: 20px 0; color: #666;">或</div>
                
                <div class="form-group">
                    <label for="imageUrl">图片URL</label>
                    <input type="url" id="imageUrl" name="url" placeholder="https://example.com/image.jpg">
                </div>
                
                <button type="submit" class="btn">添加图片</button>
            </form>
        </div>
        
        <div id="manageTab" class="tab-content">
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-group">
                    <label for="filterCategory">筛选分类</label>
                    <select id="filterCategory" onchange="loadImages(1)">
                        <option value="">所有分类</option>
                        <option value="landscape">风景</option>
                        <option value="anime">动漫</option>
                        <option value="beauty">美女</option>
                        <option value="nature">自然</option>
                        <option value="city">城市</option>
                        <option value="art">艺术</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterOrientation">筛选方向</label>
                    <select id="filterOrientation" onchange="loadImages(1)">
                        <option value="">所有方向</option>
                        <option value="landscape">横屏</option>
                        <option value="portrait">竖屏</option>
                    </select>
                </div>
            </div>
            
            <!-- 批量操作工具栏 -->
            <div id="batchToolbar" class="batch-toolbar" style="display: none;">
                <div class="batch-actions">
                    <button class="btn btn-secondary" onclick="selectAllImages()">全选</button>
                    <button class="btn btn-secondary" onclick="deselectAllImages()">取消全选</button>
                    <select id="batchCategory">
                        <option value="">批量修改分类</option>
                        <option value="landscape">风景</option>
                        <option value="anime">动漫</option>
                        <option value="beauty">美女</option>
                        <option value="nature">自然</option>
                        <option value="city">城市</option>
                        <option value="art">艺术</option>
                    </select>
                    <button class="btn btn-warning" onclick="batchUpdateCategory()">应用分类</button>
                    <button class="btn btn-danger" onclick="batchDeleteImages()">批量删除</button>
                    <span id="selectedCount" class="selected-count">已选择 0 项</span>
                </div>
            </div>
            
            <div class="pagination-info" style="margin-bottom: 15px; text-align: center; color: #666;">
                <span id="paginationInfo">加载中...</span>
            </div>
            
            <div id="imagesContainer" class="images-grid">
                <div class="loading">加载中...</div>
            </div>
            
            <div class="pagination" id="pagination" style="display: none;">
                <button class="btn btn-secondary" id="prevBtn" onclick="loadPrevPage()" disabled>上一页</button>
                <div class="page-numbers" id="pageNumbers"></div>
                <button class="btn btn-secondary" id="nextBtn" onclick="loadNextPage()" disabled>下一页</button>
            </div>
        </div>
        
        
        <div id="usersTab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>账号管理</h2>
                <button class="btn" onclick="showCreateUserModal()">添加账号</button>
            </div>
            
            <div id="usersContainer" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <div class="loading">加载中...</div>
            </div>
        </div>
        
        <div id="securityTab" class="tab-content">
            <h2>安全设置</h2>
            
            <div style="margin-bottom: 30px;">
                <h3>修改密码</h3>
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <form id="changePasswordForm" style="max-width: 400px;">
                        <div class="form-group">
                            <label for="currentPassword">当前密码</label>
                            <input type="password" id="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">新密码</label>
                            <input type="password" id="newPassword" required>
                            <small style="color: #666; font-size: 12px;">密码至少6位，包含字母和数字</small>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">确认新密码</label>
                            <input type="password" id="confirmPassword" required>
                        </div>
                        <button type="submit" class="btn">修改密码</button>
                    </form>
                </div>
            </div>
            
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>访问控制规则</h3>
                    <button class="btn" onclick="showCreateRuleModal()">添加规则</button>
                </div>
                
                <div id="accessRulesContainer" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div class="loading">加载中...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 创建用户模态框 -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateUserModal()">&times;</span>
            <h2>添加新账号</h2>
            <form id="createUserForm">
                <div class="form-group">
                    <label for="newUsername">用户名</label>
                    <input type="text" id="newUsername" required>
                </div>
                <div class="form-group">
                    <label for="newUserPassword">密码</label>
                    <input type="password" id="newUserPassword" required>
                    <small style="color: #666; font-size: 12px;">密码至少6位，包含字母和数字</small>
                </div>
                <div class="form-group">
                    <label for="newUserEmail">邮箱</label>
                    <input type="email" id="newUserEmail">
                </div>
                <div class="form-group">
                    <label for="newUserRole">角色</label>
                    <select id="newUserRole" required>
                        <option value="admin">管理员</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateUserModal()">取消</button>
                    <button type="submit" class="btn">创建账号</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 创建访问规则模态框 -->
    <div id="createRuleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateRuleModal()">&times;</span>
            <h2>添加访问控制规则</h2>
            <form id="createRuleForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="ruleType">类型</label>
                        <select id="ruleType" required>
                            <option value="ip">IP地址</option>
                            <option value="domain">域名</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ruleAction">动作</label>
                        <select id="ruleAction" required>
                            <option value="allow">允许</option>
                            <option value="deny">拒绝</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="ruleValue">值</label>
                    <input type="text" id="ruleValue" required placeholder="如: 192.168.1.*, example.com">
                    <small style="color: #666; font-size: 12px;">支持通配符，如: 192.168.*.* 或 *.example.com</small>
                </div>
                <div class="form-group">
                    <label for="ruleDescription">描述</label>
                    <input type="text" id="ruleDescription" placeholder="规则描述">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateRuleModal()">取消</button>
                    <button type="submit" class="btn">添加规则</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>编辑图片</h2>
            <form id="editForm">
                <input type="hidden" id="editImageId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editCategory">分类</label>
                        <select id="editCategory" required>
                            <option value="landscape">风景</option>
                            <option value="anime">动漫</option>
                            <option value="beauty">美女</option>
                            <option value="nature">自然</option>
                            <option value="city">城市</option>
                            <option value="art">艺术</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editOrientation">方向</label>
                        <select id="editOrientation" required>
                            <option value="landscape">横屏</option>
                            <option value="portrait">竖屏</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editImageFile">更换图片</label>
                    <input type="file" id="editImageFile" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="editImageUrl">或输入新URL</label>
                    <input type="url" id="editImageUrl" placeholder="https://example.com/image.jpg">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">取消</button>
                    <button type="submit" class="btn">保存更改</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentImages = [];
        let currentPage = 1;
        let totalPages = 1;
        let currentPagination = null;
        let currentUser = null;
        
        // 页面加载时检查登录状态
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });
        
        async function checkLoginStatus() {
            try {
                const response = await fetch('/auth/status', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (!data.isLoggedIn) {
                    window.location.href = '/login';
                    return;
                }
                
                currentUser = data.user;
                document.getElementById('userInfo').textContent = `欢迎，${data.user.username}`;
                updateStats();
            } catch (error) {
                console.error('Check login status failed:', error);
                window.location.href = '/login';
            }
        }
        
        async function logout() {
            try {
                const response = await fetch('/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    showAlert('登出失败', 'error');
                }
            } catch (error) {
                console.error('Logout error:', error);
                showAlert('网络错误', 'error');
            }
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'manage') {
                loadImages(1);
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'security') {
                loadAccessRules();
            }
        }
        
        function showAlert(message, type) {
            const alertId = type === 'success' ? 'successAlert' : 'errorAlert';
            const alert = document.getElementById(alertId);
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
        
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            const category = document.getElementById('category').value;
            const orientation = document.getElementById('orientation').value;
            const imageFile = document.getElementById('imageFile').files[0];
            const imageUrl = document.getElementById('imageUrl').value;
            
            if (!category || !orientation) {
                showAlert('请选择分类和方向', 'error');
                return;
            }
            
            if (!imageFile && !imageUrl) {
                showAlert('请上传图片文件或输入图片URL', 'error');
                return;
            }
            
            formData.append('category', category);
            formData.append('orientation', orientation);
            
            if (imageFile) {
                formData.append('image', imageFile);
            }
            
            if (imageUrl) {
                formData.append('url', imageUrl);
            }
            
            try {
                const response = await fetch('/api/images', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    showAlert('图片添加成功！', 'success');
                    document.getElementById('uploadForm').reset();
                    updateStats();
                } else {
                    const error = await response.json();
                    showAlert(error.error || '添加失败', 'error');
                }
            } catch (error) {
                showAlert('网络错误：' + error.message, 'error');
            }
        });
        
        async function loadImages(page = 1) {
            const category = document.getElementById('filterCategory').value;
            const orientation = document.getElementById('filterOrientation').value;
            
            let url = '/api/images';
            const params = new URLSearchParams();
            params.append('page', page);
            params.append('limit', '12');
            if (category) params.append('category', category);
            if (orientation) params.append('orientation', orientation);
            url += '?' + params.toString();
            
            try {
                document.getElementById('imagesContainer').innerHTML = '<div class="loading">加载中...</div>';
                
                const response = await fetch(url);
                const result = await response.json();
                
                currentImages = result.data;
                currentPage = result.pagination.page;
                totalPages = result.pagination.totalPages;
                currentPagination = result.pagination;
                
                displayImages(result.data);
                updatePaginationInfo(result.pagination);
                updatePaginationControls(result.pagination);
            } catch (error) {
                document.getElementById('imagesContainer').innerHTML = '<div class="loading">加载失败</div>';
            }
        }
        
        function displayImages(images) {
            const container = document.getElementById('imagesContainer');
            
            if (images.length === 0) {
                container.innerHTML = '<div class="loading">没有找到图片</div>';
                document.getElementById('pagination').style.display = 'none';
                return;
            }
            
            container.innerHTML = images.map(image => {
                // 构建缩略图URL
                let thumbnailUrl = '';
                if (image.is_local && image.thumbnail) {
                    thumbnailUrl = `/api/thumbnails/${image.thumbnail}`;
                } else if (image.is_local) {
                    thumbnailUrl = `/api/images/${image.id}`;
                } else {
                    // 对于URL图片，尝试使用原图
                    thumbnailUrl = image.url;
                }
                
                return `
                <div class="image-card" data-image-id="${image.id}">
                    <div class="thumbnail-container">
                        <input type="checkbox" class="image-checkbox" onchange="toggleImageSelection(${image.id}, this)">
                        <img src="${thumbnailUrl}" 
                             alt="${image.original_name || '图片'}" 
                             class="thumbnail"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxjaXJjbGUgY3g9IjEwMCIgY3k9IjEwMCIgcj0iMzAiIGZpbGw9IiNEMUQ1REIiLz4KPHN2Zz4K'">
                        <div class="thumbnail-overlay">
                            <span class="image-id">#${image.id}</span>
                        </div>
                    </div>
                    <div class="image-card-content">
                        <div class="image-card-title">${image.original_name || 'URL图片'}</div>
                        <div class="image-card-meta">
                            分类: ${getCategoryName(image.category)} | 
                            方向: ${image.orientation === 'landscape' ? '横屏' : '竖屏'} |
                            ${image.is_local ? '本地' : 'URL'}
                        </div>
                        <div class="image-card-actions">
                            <button class="btn btn-secondary" onclick="editImage(${image.id})">编辑</button>
                            <button class="btn btn-danger" onclick="deleteImage(${image.id})">删除</button>
                        </div>
                    </div>
                </div>
            `}).join('');
            
            // 显示或隐藏批量操作工具栏
            updateBatchToolbarVisibility();
        }
        
        // 批量操作相关变量和函数
        let selectedImages = new Set();
        
        function toggleImageSelection(imageId, checkbox) {
            const imageCard = checkbox.closest('.image-card');
            
            if (checkbox.checked) {
                selectedImages.add(imageId);
                imageCard.classList.add('selected');
            } else {
                selectedImages.delete(imageId);
                imageCard.classList.remove('selected');
            }
            
            updateSelectedCount();
            updateBatchToolbarVisibility();
        }
        
        function selectAllImages() {
            const checkboxes = document.querySelectorAll('.image-checkbox');
            checkboxes.forEach(checkbox => {
                if (!checkbox.checked) {
                    checkbox.checked = true;
                    toggleImageSelection(parseInt(checkbox.closest('.image-card').dataset.imageId), checkbox);
                }
            });
        }
        
        function deselectAllImages() {
            const checkboxes = document.querySelectorAll('.image-checkbox');
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    checkbox.checked = false;
                    toggleImageSelection(parseInt(checkbox.closest('.image-card').dataset.imageId), checkbox);
                }
            });
        }
        
        function updateSelectedCount() {
            const countEl = document.getElementById('selectedCount');
            countEl.textContent = `已选择 ${selectedImages.size} 项`;
        }
        
        function updateBatchToolbarVisibility() {
            const toolbar = document.getElementById('batchToolbar');
            if (selectedImages.size > 0) {
                toolbar.style.display = 'block';
            } else {
                toolbar.style.display = 'none';
            }
        }
        
        async function batchUpdateCategory() {
            const newCategory = document.getElementById('batchCategory').value;
            if (!newCategory) {
                alert('请选择要修改的分类');
                return;
            }
            
            if (selectedImages.size === 0) {
                alert('请先选择要修改的图片');
                return;
            }
            
            if (!confirm(`确定要将选中的 ${selectedImages.size} 张图片的分类修改为 ${getCategoryName(newCategory)} 吗？`)) {
                return;
            }
            
            try {
                const promises = Array.from(selectedImages).map(imageId => 
                    fetch(`/api/images/${imageId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ category: newCategory })
                    })
                );
                
                await Promise.all(promises);
                
                alert('批量修改分类成功！');
                deselectAllImages();
                loadImages(currentPagination?.page || 1);
                loadStats();
            } catch (error) {
                alert('批量修改分类失败：' + error.message);
            }
        }
        
        async function batchDeleteImages() {
            if (selectedImages.size === 0) {
                alert('请先选择要删除的图片');
                return;
            }
            
            if (!confirm(`确定要删除选中的 ${selectedImages.size} 张图片吗？此操作不可恢复！`)) {
                return;
            }
            
            try {
                const promises = Array.from(selectedImages).map(imageId => 
                    fetch(`/api/images/${imageId}`, {
                        method: 'DELETE'
                    })
                );
                
                await Promise.all(promises);
                
                alert('批量删除成功！');
                deselectAllImages();
                loadImages(currentPagination?.page || 1);
                loadStats();
            } catch (error) {
                alert('批量删除失败：' + error.message);
            }
        }
        
        function updatePaginationInfo(pagination) {
            const info = document.getElementById('paginationInfo');
            const start = (pagination.page - 1) * pagination.limit + 1;
            const end = Math.min(pagination.page * pagination.limit, pagination.total);
            info.textContent = `显示 ${start}-${end} 条，共 ${pagination.total} 条记录（第 ${pagination.page}/${pagination.totalPages} 页）`;
        }
        
        function updatePaginationControls(pagination) {
            const paginationEl = document.getElementById('pagination');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pageNumbers = document.getElementById('pageNumbers');
            
            if (pagination.totalPages <= 1) {
                paginationEl.style.display = 'none';
                return;
            }
            
            paginationEl.style.display = 'flex';
            
            // 更新上一页/下一页按钮
            prevBtn.disabled = !pagination.hasPrev;
            nextBtn.disabled = !pagination.hasNext;
            
            // 生成页码
            pageNumbers.innerHTML = '';
            const maxVisible = 5;
            let startPage = Math.max(1, pagination.page - Math.floor(maxVisible / 2));
            let endPage = Math.min(pagination.totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            // 第一页
            if (startPage > 1) {
                pageNumbers.appendChild(createPageButton(1, pagination.page));
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'page-number disabled';
                    pageNumbers.appendChild(ellipsis);
                }
            }
            
            // 页码范围
            for (let i = startPage; i <= endPage; i++) {
                pageNumbers.appendChild(createPageButton(i, pagination.page));
            }
            
            // 最后一页
            if (endPage < pagination.totalPages) {
                if (endPage < pagination.totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'page-number disabled';
                    pageNumbers.appendChild(ellipsis);
                }
                pageNumbers.appendChild(createPageButton(pagination.totalPages, pagination.page));
            }
        }
        
        function createPageButton(pageNum, currentPage) {
            const button = document.createElement('span');
            button.textContent = pageNum;
            button.className = `page-number ${pageNum === currentPage ? 'active' : ''}`;
            button.onclick = () => loadImages(pageNum);
            return button;
        }
        
        function loadPrevPage() {
            if (currentPage > 1) {
                loadImages(currentPage - 1);
            }
        }
        
        function loadNextPage() {
            if (currentPage < totalPages) {
                loadImages(currentPage + 1);
            }
        }
        
        function getCategoryName(category) {
            const names = {
                'landscape': '风景',
                'anime': '动漫',
                'beauty': '美女',
                'nature': '自然',
                'city': '城市',
                'art': '艺术'
            };
            return names[category] || category;
        }
        
        function editImage(id) {
            const image = currentImages.find(img => img.id === id);
            if (!image) return;
            
            document.getElementById('editImageId').value = id;
            document.getElementById('editCategory').value = image.category;
            document.getElementById('editOrientation').value = image.orientation;
            document.getElementById('editImageFile').value = '';
            document.getElementById('editImageUrl').value = image.url || '';
            
            document.getElementById('editModal').style.display = 'block';
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('editImageId').value;
            const formData = new FormData();
            
            formData.append('category', document.getElementById('editCategory').value);
            formData.append('orientation', document.getElementById('editOrientation').value);
            
            const imageFile = document.getElementById('editImageFile').files[0];
            const imageUrl = document.getElementById('editImageUrl').value;
            
            if (imageFile) {
                formData.append('image', imageFile);
            }
            
            if (imageUrl) {
                formData.append('url', imageUrl);
            }
            
            try {
                const response = await fetch(`/api/images/${id}`, {
                    method: 'PUT',
                    body: formData
                });
                
                if (response.ok) {
                    showAlert('图片更新成功！', 'success');
                    closeEditModal();
                    loadImages(currentPage);
                    updateStats();
                } else {
                    const error = await response.json();
                    showAlert(error.error || '更新失败', 'error');
                }
            } catch (error) {
                showAlert('网络错误：' + error.message, 'error');
            }
        });
        
        async function deleteImage(id) {
            if (!confirm('确定要删除这张图片吗？')) return;
            
            try {
                const response = await fetch(`/api/images/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('图片删除成功！', 'success');
                    loadImages(currentPage);
                    updateStats();
                } else {
                    const error = await response.json();
                    showAlert(error.error || '删除失败', 'error');
                }
            } catch (error) {
                showAlert('网络错误：' + error.message, 'error');
            }
        }
        
        
        // 用户管理功能
        async function loadUsers() {
            try {
                const response = await fetch('/auth/users', {
                    credentials: 'include'
                });
                const users = await response.json();
                
                displayUsers(users);
            } catch (error) {
                console.error('Load users error:', error);
                document.getElementById('usersContainer').innerHTML = '<div class="loading">加载失败</div>';
            }
        }
        
        function displayUsers(users) {
            const container = document.getElementById('usersContainer');
            
            if (users.length === 0) {
                container.innerHTML = '<div class="loading">暂无用户</div>';
                return;
            }
            
            const table = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">用户名</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">邮箱</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">角色</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">状态</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">最后登录</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr style="border-bottom: 1px solid #e1e5e9;">
                                <td style="padding: 12px;">${user.username}</td>
                                <td style="padding: 12px;">${user.email || '-'}</td>
                                <td style="padding: 12px;">${user.role}</td>
                                <td style="padding: 12px;">
                                    <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; ${user.is_active ? 'background: #d4edda; color: #155724;' : 'background: #f8d7da; color: #721c24;'}">
                                        ${user.is_active ? '活跃' : '禁用'}
                                    </span>
                                </td>
                                <td style="padding: 12px;">${user.last_login ? new Date(user.last_login).toLocaleString() : '从未登录'}</td>
                                <td style="padding: 12px;">
                                    ${user.id !== currentUser.id ? `
                                        <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deleteUser(${user.id})">删除</button>
                                    ` : '<span style="color: #666; font-size: 12px;">当前用户</span>'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }
        
        function showCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'block';
        }
        
        function closeCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'none';
            document.getElementById('createUserForm').reset();
        }
        
        document.getElementById('createUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('username', document.getElementById('newUsername').value);
            formData.append('password', document.getElementById('newUserPassword').value);
            formData.append('email', document.getElementById('newUserEmail').value);
            formData.append('role', document.getElementById('newUserRole').value);
            
            try {
                const response = await fetch('/auth/users', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showAlert('用户创建成功', 'success');
                    closeCreateUserModal();
                    loadUsers();
                } else {
                    showAlert(data.error || '创建用户失败', 'error');
                }
            } catch (error) {
                showAlert('网络错误：' + error.message, 'error');
            }
        });
        
        async function deleteUser(userId) {
            if (!confirm('确定要删除这个用户吗？')) return;
            
            try {
                const response = await fetch(`/auth/users/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showAlert('用户删除成功', 'success');
                    loadUsers();
                } else {
                    showAlert(data.error || '删除用户失败', 'error');
                }
            } catch (error) {
                showAlert('网络错误：' + error.message, 'error');
            }
        }
        
        // 修改密码功能
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showAlert('新密码和确认密码不一致', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('currentPassword', currentPassword);
            formData.append('newPassword', newPassword);
            
            try {
                const response = await fetch('/auth/change-password', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showAlert('密码修改成功', 'success');
                    document.getElementById('changePasswordForm').reset();
                } else {
                    showAlert(data.error || '修改密码失败', 'error');
                }
            } catch (error) {
                showAlert('网络错误：' + error.message, 'error');
            }
        });
        
        // 访问控制功能
        async function loadAccessRules() {
            try {
                const response = await fetch('/auth/access-rules', {
                    credentials: 'include'
                });
                const rules = await response.json();
                
                displayAccessRules(rules);
            } catch (error) {
                console.error('Load access rules error:', error);
                document.getElementById('accessRulesContainer').innerHTML = '<div class="loading">加载失败</div>';
            }
        }
        
        function displayAccessRules(rules) {
            const container = document.getElementById('accessRulesContainer');
            
            if (rules.length === 0) {
                container.innerHTML = '<div class="loading">暂无访问控制规则，默认允许所有访问</div>';
                return;
            }
            
            const table = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">类型</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">值</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">动作</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">描述</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">创建时间</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rules.map(rule => `
                            <tr style="border-bottom: 1px solid #e1e5e9;">
                                <td style="padding: 12px;">${rule.type === 'ip' ? 'IP地址' : '域名'}</td>
                                <td style="padding: 12px; font-family: monospace;">${rule.value}</td>
                                <td style="padding: 12px;">
                                    <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; ${rule.action === 'allow' ? 'background: #d4edda; color: #155724;' : 'background: #f8d7da; color: #721c24;'}">
                                        ${rule.action === 'allow' ? '允许' : '拒绝'}
                                    </span>
                                </td>
                                <td style="padding: 12px;">${rule.description || '-'}</td>
                                <td style="padding: 12px;">${new Date(rule.created_at).toLocaleString()}</td>
                                <td style="padding: 12px;">
                                    <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deleteAccessRule(${rule.id})">删除</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }
        
        function showCreateRuleModal() {
            document.getElementById('createRuleModal').style.display = 'block';
        }
        
        function closeCreateRuleModal() {
            document.getElementById('createRuleModal').style.display = 'none';
            document.getElementById('createRuleForm').reset();
        }
        
        document.getElementById('createRuleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('type', document.getElementById('ruleType').value);
            formData.append('value', document.getElementById('ruleValue').value);
            formData.append('action', document.getElementById('ruleAction').value);
            formData.append('description', document.getElementById('ruleDescription').value);
            
            try {
                const response = await fetch('/auth/access-rules', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showAlert('访问规则添加成功', 'success');
                    closeCreateRuleModal();
                    loadAccessRules();
                } else {
                    showAlert(data.error || '添加访问规则失败', 'error');
                }
            } catch (error) {
                showAlert('网络错误：' + error.message, 'error');
            }
        });
        
        async function deleteAccessRule(ruleId) {
            if (!confirm('确定要删除这个访问规则吗？')) return;
            
            try {
                const response = await fetch(`/auth/access-rules/${ruleId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showAlert('访问规则删除成功', 'success');
                    loadAccessRules();
                } else {
                    showAlert(data.error || '删除访问规则失败', 'error');
                }
            } catch (error) {
                showAlert('网络错误：' + error.message, 'error');
            }
        }
        
        async function updateStats() {
            try {
                const response = await fetch('/api/images?paginated=false');
                const images = await response.json();
                
                const total = images.length;
                const landscape = images.filter(img => img.orientation === 'landscape').length;
                const portrait = images.filter(img => img.orientation === 'portrait').length;
                const categories = new Set(images.map(img => img.category)).size;
                
                document.getElementById('totalImages').textContent = total;
                document.getElementById('landscapeImages').textContent = landscape;
                document.getElementById('portraitImages').textContent = portrait;
                document.getElementById('categories').textContent = categories;
            } catch (error) {
                console.error('Failed to update stats:', error);
            }
        }
        
        window.onclick = function(event) {
            const modals = ['editModal', 'createUserModal', 'createRuleModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>